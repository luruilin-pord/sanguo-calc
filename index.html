<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‰å›½å†°æ²³Â·æ™ºèƒ½è·‘å•†åˆ†æå™¨ (OCR ç‰ˆ)</title>
    <!-- å¼•å…¥ Tesseract.js ç”¨äºæœ¬åœ° OCR è¯†åˆ« -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <!-- å¼•å…¥ Chart.js ç”¨äºç»˜å›¾ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #d4a017; --bg: #f4f1ea; --card: #fffdf5; --text: #5d4037; --accent: #8b5a2b; }
        body { font-family: 'Microsoft YaHei', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        h1 { text-align: center; color: var(--accent); text-shadow: 1px 1px 2px rgba(0,0,0,0.2); margin-bottom: 10px; }
        
        /* ä¸Šä¼ åŒºåŸŸ */
        .upload-zone {
            border: 3px dashed var(--accent); background: var(--card); border-radius: 15px;
            padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s;
            margin-bottom: 20px; position: relative;
        }
        .upload-zone:hover { background: #fff; border-color: var(--primary); }
        .upload-zone.dragover { background: #fff8e1; border-color: var(--primary); }
        .upload-icon { font-size: 50px; margin-bottom: 10px; display: block; }
        
        /* è¿›åº¦æ¡ */
        .progress-container { display: none; margin-top: 15px; }
        .progress-bar { width: 100%; height: 10px; background: #ddd; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), #f0c040); width: 0%; transition: width 0.3s; }
        
        /* è¡¨æ ¼æ ·å¼ */
        .table-wrapper { overflow-x: auto; background: var(--card); border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background: var(--accent); color: #fff; padding: 12px; text-align: left; font-weight: 600; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        tr:hover { background: #fff8e1; }
        input { width: 90%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; background: #fff; font-size: 14px; }
        input:focus { border-color: var(--primary); outline: none; }
        .highlight-row { background: #e8f5e9 !important; border-left: 5px solid #2e7d32; }
        .negative-profit { color: #c62828; }
        .positive-profit { color: #2e7d32; }
        
        /* æŒ‰é’® */
        .btn { background: var(--primary); color: #fff; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; display: block; margin: 20px auto; transition: all 0.3s; }
        .btn:hover { background: var(--accent); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        
        /* ç»“æœå¡ç‰‡ */
        .result-card { background: var(--card); padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; margin-bottom: 20px; }
        .best-route { font-size: 20px; color: #d32f2f; font-weight: bold; margin-bottom: 15px; padding: 15px; background: #fff8e1; border-radius: 8px; border-left: 5px solid var(--primary); }
        
        /* å›¾è¡¨ */
        .chart-container { position: relative; height: 300px; width: 100%; margin-top: 20px; }
        
        /* è°ƒè¯•ä¿¡æ¯ */
        .debug-info { background: #f5f5f5; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; margin-top: 20px; display: none; }
        .debug-toggle { color: #666; font-size: 12px; cursor: pointer; text-align: right; margin-top: 10px; }
        
        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .upload-zone { padding: 20px; }
            h1 { font-size: 24px; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ§Š ä¸‰å›½å†°æ²³Â·æ™ºèƒ½è·‘å•†åˆ†æå™¨ (ä¼˜åŒ–ç‰ˆ)</h1>
    <p style="text-align:center; color:#666; margin-bottom: 20px;">ä¸Šä¼  1-2 å¼ æ¸¸æˆæˆªå›¾ï¼Œè‡ªåŠ¨è¯†åˆ«ä»·æ ¼ã€åº“å­˜å¹¶è®¡ç®—æœ€ä½³è·¯çº¿<br>æ”¯æŒæˆˆå±…ã€å¤©æ°´ã€å¯Œå¹³ç­‰14åº§åŸæ± çš„è·‘å•†æ•°æ®åˆ†æ</p>

    <!-- ä¸Šä¼ åŒº -->
    <div class="upload-zone" id="dropZone">
        <span class="upload-icon">ğŸ“¸</span>
        <h3>ç‚¹å‡»æˆ–æ‹–æ‹½æˆªå›¾åˆ°è¿™é‡Œ</h3>
        <p style="font-size:14px; color:#999;">æ”¯æŒåŒæ—¶ä¸Šä¼  2 å¼ ä»¥å¯¹æ¯”ä»·æ ¼æ³¢åŠ¨ï¼Œå»ºè®®ä½¿ç”¨æ¸…æ™°çš„äº¤æ˜“ç•Œé¢æˆªå›¾</p>
        <input type="file" id="fileInput" multiple accept="image/*" style="display:none">
        
        <div class="progress-container" id="progressContainer">
            <div style="display:flex; justify-content:space-between; font-size:14px; margin-bottom:8px;">
                <span id="statusText">æ­£åœ¨è¯†åˆ«...</span>
                <span id="percentText">0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>
    </div>

    <!-- æ•°æ®æ ¡å¯¹è¡¨ -->
    <div id="dataSection" style="display:none;">
        <h3>ğŸ“ è¯†åˆ«æ•°æ®æ ¡å¯¹ (è¯·æ£€æŸ¥æ•°å­—æ˜¯å¦æ­£ç¡®)</h3>
        <p style="color:#666; font-size:14px; margin-bottom: 10px;">è¯†åˆ«åˆ° <span id="routeCount">0</span> æ¡äº¤æ˜“è·¯çº¿ï¼Œæ‚¨å¯ä»¥åœ¨è¡¨æ ¼ä¸­ä¿®æ­£æ•°æ®</p>
        <div class="table-wrapper">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>å•†å“</th>
                        <th>ä¹°å…¥åŸæ± </th>
                        <th>ä¹°å…¥ä»·</th>
                        <th>å‰©ä½™é‡</th>
                        <th>ç›®æ ‡åŸæ±  (ä¼ é—»)</th>
                        <th>å–å‡ºä»· (ä¼ é—»)</th>
                        <th>åˆ©æ¶¦ç‡</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <button class="btn" onclick="analyzeData()" id="analyzeBtn">ğŸš€ å¼€å§‹åˆ†æä¸ç»˜å›¾</button>
        
        <div class="debug-toggle" onclick="toggleDebug()">æ˜¾ç¤º/éšè—è°ƒè¯•ä¿¡æ¯</div>
        <div class="debug-info" id="debugInfo"></div>
    </div>

    <!-- åˆ†æç»“æœ -->
    <div id="resultSection" class="result-card">
        <h3>ğŸ“Š åˆ†ææŠ¥å‘Š</h3>
        <div id="analysisContent"></div>
        <div class="chart-container">
            <canvas id="trendChart"></canvas>
        </div>
    </div>
</div>

<script>
    // æ¸¸æˆæ•°æ®å­—å…¸ï¼Œè¾…åŠ© OCR ä¿®æ­£
    const CITIES = ["æˆˆå±…", "æˆçºª", "å¤©æ°´", "è™å¨", "æ¸Šæ³‰", "å¯Œå¹³", "ç¥–å‰", "é‡‘åŸ", "ç™½åœŸ", "è‚¤æ–½", "å§‘è‡§", "å¹³è¥„", "è¡—äº­", "ä¸´æˆ"];
    const ITEMS = ["é»åœŸ", "æ£‰èŠ±", "è°·ç‰©", "è‘¡è„", "ç¡¬æœ¨", "è¯æ", "é¦™æ–™", "æ¯›çš®", "èœ‚èœœ", "ç›", "ç±³é…’", "é™¶å™¨", "è‘¡è„é…’", "å…µå™¨", "é“œå™¨", "å·¥å…·", "å¸ƒå¸›", "èœ€é”¦", "æ¼†å™¨", "ç‰å™¨", "æµ·å—çç ", "é‡‘é“¶å™¨", "é“œçŸ¿çŸ³", "é“çŸ¿çŸ³", "èŒ¶å¶"];

    let rawData = [];
    let chartInstance = null;
    let debugLogs = [];

    // åˆå§‹åŒ–æ‹–æ‹½
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    
    dropZone.addEventListener('click', () => fileInput.click());
    
    dropZone.addEventListener('dragover', e => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });
    
    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
    });
    
    dropZone.addEventListener('drop', e => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    });
    
    fileInput.addEventListener('change', e => handleFiles(e.target.files));

    function toggleDebug() {
        const debugEl = document.getElementById('debugInfo');
        debugEl.style.display = debugEl.style.display === 'block' ? 'none' : 'block';
    }

    function addDebugLog(message) {
        const timestamp = new Date().toLocaleTimeString();
        debugLogs.push(`[${timestamp}] ${message}`);
        
        const debugEl = document.getElementById('debugInfo');
        debugEl.innerHTML = debugLogs.map(log => `<div>${log}</div>`).join('');
        debugEl.scrollTop = debugEl.scrollHeight;
    }

    async function handleFiles(files) {
        if (files.length === 0) return;
        if (files.length > 2) { 
            alert("æœ€å¤šä¸Šä¼  2 å¼ è¿›è¡Œå¯¹æ¯”"); 
            return; 
        }

        rawData = [];
        debugLogs = [];
        document.getElementById('debugInfo').innerHTML = '';
        document.getElementById('dataSection').style.display = 'none';
        document.getElementById('resultSection').style.display = 'none';
        document.getElementById('progressContainer').style.display = 'block';
        document.getElementById('analyzeBtn').disabled = true;

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            updateProgress(`æ­£åœ¨å¤„ç†å›¾ç‰‡ ${i+1}/${files.length}...`, (i/files.length) * 50);
            addDebugLog(`å¼€å§‹å¤„ç†æ–‡ä»¶: ${file.name}`);
            
            try {
                // ä½¿ç”¨ Tesseract è¿›è¡Œä¸­æ–‡è¯†åˆ«
                const { data: { text } } = await Tesseract.recognize(file, 'chi_sim+eng', {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            updateProgress(`è¯†åˆ«ä¸­ï¼š${Math.round(m.progress * 100)}%`, 50 + (i/files.length) * 50);
                        }
                    }
                });
                
                addDebugLog(`OCRè¯†åˆ«ç»“æœ:\n${text}`);
                parseGameText(text, `æˆªå›¾${i+1}`);
            } catch (err) {
                console.error(err);
                addDebugLog(`è¯†åˆ«é”™è¯¯: ${err.message}`);
                alert("è¯†åˆ«å¤±è´¥ï¼Œè¯·ç¡®ä¿å›¾ç‰‡æ¸…æ™°");
            }
        }

        updateProgress("è¯†åˆ«å®Œæˆï¼Œè¯·æ ¡å¯¹æ•°æ®", 100);
        setTimeout(() => {
            document.getElementById('progressContainer').style.display = 'none';
            if (rawData.length > 0) {
                document.getElementById('dataSection').style.display = 'block';
                document.getElementById('analyzeBtn').disabled = false;
                renderTable();
            } else {
                alert("æœªè¯†åˆ«åˆ°ä»»ä½•æ•°æ®ï¼Œè¯·æ£€æŸ¥æˆªå›¾æ˜¯å¦åŒ…å«äº¤æ˜“ä¿¡æ¯");
            }
        }, 1000);
    }

    function updateProgress(text, percent) {
        document.getElementById('statusText').innerText = text;
        document.getElementById('percentText').innerText = Math.round(percent) + '%';
        document.getElementById('progressFill').style.width = percent + '%';
    }

    // æ ¸å¿ƒè§£æé€»è¾‘ï¼šä» OCR æ–‡æœ¬ä¸­æå–ç»“æ„åŒ–æ•°æ®
    function parseGameText(text, sourceName) {
        const lines = text.split('\n');
        let currentItem = null;
        let currentCity = "æœªçŸ¥";
        let parsingState = "å¯»æ‰¾å•†å“";
        
        addDebugLog(`å¼€å§‹è§£ææ–‡æœ¬ï¼Œè¡Œæ•°: ${lines.length}`);
        
        // é¦–å…ˆå°è¯•ä»æ–‡æœ¬ä¸­è¯†åˆ«å½“å‰åŸå¸‚
        for (let i = 0; i < Math.min(3, lines.length); i++) {
            const line = lines[i].trim();
            if (line.includes("åŠå¸‚")) {
                for (const city of CITIES) {
                    if (line.includes(city)) {
                        currentCity = city;
                        break;
                    }
                }
            }
        }
        
        if (currentCity === "æœªçŸ¥") {
            addDebugLog("æœªè¯†åˆ«åˆ°åŸå¸‚åï¼Œä½¿ç”¨é»˜è®¤å€¼: æˆˆå±…");
            currentCity = "æˆˆå±…";
        } else {
            addDebugLog(`è¯†åˆ«åˆ°å½“å‰åŸå¸‚: ${currentCity}`);
        }
        
        for (let i = 0; i < lines.length; i++) {
            let line = lines[i].trim();
            if (!line) continue;
            
            // 1. å¯»æ‰¾å•†å“è¡Œ
            if (parsingState === "å¯»æ‰¾å•†å“") {
                const foundItem = ITEMS.find(item => {
                    const index = line.indexOf(item);
                    return index >= 0 && index < 5; // å•†å“åé€šå¸¸åœ¨è¡Œé¦–
                });
                
                if (foundItem) {
                    // å¦‚æœæœ‰ä¸Šä¸€ä¸ªå•†å“ï¼Œå…ˆä¿å­˜
                    if (currentItem && currentItem.name && currentItem.buyPrice) {
                        rawData.push({...currentItem});
                    }
                    
                    currentItem = {
                        name: foundItem,
                        source: sourceName,
                        buyCity: currentCity,
                        buyPrice: null,
                        stock: null,
                        sellCity: null,
                        sellPrice: null
                    };
                    
                    parsingState = "è§£æå•†å“ä¿¡æ¯";
                    addDebugLog(`æ‰¾åˆ°å•†å“: ${foundItem}`);
                    
                    // å°è¯•åœ¨åŒä¸€è¡Œè§£æä¹°å…¥ä»·æ ¼
                    const priceMatch = line.match(/(\d+\.?\d*)/g);
                    if (priceMatch && priceMatch.length > 0) {
                        // å‡è®¾ç¬¬ä¸€ä¸ªæ•°å­—æ˜¯ä¹°å…¥ä»·
                        const price = parseFloat(priceMatch[0]);
                        if (!isNaN(price) && price > 0) {
                            currentItem.buyPrice = price;
                            addDebugLog(`  ä¹°å…¥ä»·: ${price}`);
                        }
                    }
                    
                    continue;
                }
            }
            
            // 2. è§£æå•†å“ä¿¡æ¯
            if (parsingState === "è§£æå•†å“ä¿¡æ¯" && currentItem) {
                // å°è¯•åŒ¹é…ä¹°å…¥ä»·æ ¼
                if (currentItem.buyPrice === null && (line.includes("ä¹°å…¥ä»·æ ¼") || line.includes("ä¹°å…¥ä»·"))) {
                    const priceMatch = line.match(/(\d+\.?\d*)/);
                    if (priceMatch) {
                        currentItem.buyPrice = parseFloat(priceMatch[1]);
                        addDebugLog(`  ä¹°å…¥ä»·: ${currentItem.buyPrice}`);
                    }
                }
                
                // å°è¯•åŒ¹é…å‰©ä½™é‡
                if (currentItem.stock === null && (line.includes("å‰©ä½™") || line.includes("åº“å­˜"))) {
                    const stockMatch = line.match(/(\d+)/);
                    if (stockMatch) {
                        currentItem.stock = parseInt(stockMatch[1]);
                        addDebugLog(`  å‰©ä½™é‡: ${currentItem.stock}`);
                    }
                }
                
                // å¦‚æœå·²è·å–å¿…è¦ä¿¡æ¯ï¼Œè½¬ä¸ºå¯»æ‰¾ä¼ é—»
                if (currentItem.buyPrice !== null && currentItem.stock !== null) {
                    parsingState = "å¯»æ‰¾ä¼ é—»";
                }
                
                // å¦‚æœé‡åˆ°ä¸‹ä¸€è¡Œå¯èƒ½æ˜¯æ–°å•†å“ï¼Œç»“æŸå½“å‰å•†å“
                if (i + 1 < lines.length) {
                    const nextLine = lines[i + 1].trim();
                    const isNextItem = ITEMS.some(item => {
                        const index = nextLine.indexOf(item);
                        return index >= 0 && index < 5;
                    });
                    
                    if (isNextItem) {
                        if (currentItem.name && currentItem.buyPrice) {
                            rawData.push({...currentItem});
                        }
                        currentItem = null;
                        parsingState = "å¯»æ‰¾å•†å“";
                    }
                }
            }
            
            // 3. å¯»æ‰¾ä¼ é—»
            if (parsingState === "å¯»æ‰¾ä¼ é—»" && currentItem) {
                // åŒ¹é…ä¼ é—»æ ¼å¼: ä¼ é—»X:æ®è¯´[åŸæ± ]çš„å–å‡ºä»·æ ¼ä¸ºä»·æ ¼
                const rumorMatch = line.match(/ä¼ é—»\d*[:ï¼š]?æ®è¯´\[([\u4e00-\u9fa5]+)\]çš„å–å‡ºä»·æ ¼ä¸º\s*(\d+\.?\d*)/);
                if (rumorMatch && rumorMatch[1] && rumorMatch[2]) {
                    const sellCity = rumorMatch[1];
                    const sellPrice = parseFloat(rumorMatch[2]);
                    
                    // æ£€æŸ¥æ˜¯å¦åœ¨å·²çŸ¥åŸå¸‚åˆ—è¡¨ä¸­
                    if (CITIES.includes(sellCity)) {
                        const routeData = {
                            name: currentItem.name,
                            source: sourceName,
                            buyCity: currentItem.buyCity,
                            buyPrice: currentItem.buyPrice,
                            stock: currentItem.stock,
                            sellCity: sellCity,
                            sellPrice: sellPrice
                        };
                        rawData.push(routeData);
                        addDebugLog(`  æ‰¾åˆ°ä¼ é—»: ${sellCity} -> ${sellPrice}`);
                    }
                }
                
                // å¦‚æœé‡åˆ°"æš‚æ— ä¼ é—»"æˆ–åˆ°è¾¾æ–‡æœ¬æœ«å°¾
                if (line.includes("æš‚æ— ä¼ é—»") || i === lines.length - 1) {
                    parsingState = "å¯»æ‰¾å•†å“";
                }
            }
        }
        
        // å¤„ç†æœ€åä¸€ä¸ªå•†å“
        if (currentItem && currentItem.name && currentItem.buyPrice) {
            rawData.push({...currentItem});
        }
        
        addDebugLog(`è§£æå®Œæˆï¼Œæ‰¾åˆ°è®°å½•: ${rawData.length} æ¡`);
    }

    function renderTable() {
        const tbody = document.querySelector('#dataTable tbody');
        tbody.innerHTML = '';
        
        // è¿‡æ»¤æ‰æ²¡æœ‰ä¹°å…¥ä»·æˆ–å–å‡ºä»·çš„è®°å½•
        const routes = rawData.filter(r => r.buyPrice && r.sellPrice && r.sellCity);
        
        document.getElementById('routeCount').textContent = routes.length;
        
        if (routes.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
                        <div style="font-size: 24px; margin-bottom: 10px;">ğŸ“·</div>
                        <div>æœªè¯†åˆ«åˆ°å®Œæ•´çš„äº¤æ˜“è·¯çº¿</div>
                        <div style="font-size: 12px; margin-top: 10px;">è¯·æ£€æŸ¥æˆªå›¾æ˜¯å¦åŒ…å«å®Œæ•´çš„å•†å“ä¿¡æ¯ã€ä»·æ ¼å’Œä¼ é—»</div>
                    </td>
                </tr>
            `;
            return;
        }
        
        routes.forEach((r, index) => {
            const profit = r.sellPrice - r.buyPrice;
            const rate = ((profit / r.buyPrice) * 100).toFixed(1);
            const profitClass = profit > 0 ? 'positive-profit' : 'negative-profit';
            const profitSign = profit > 0 ? '+' : '';
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <input value="${r.name}" onchange="updateRow(${index}, 'name', this.value)" list="itemList">
                </td>
                <td>
                    <input value="${r.buyCity}" onchange="updateRow(${index}, 'buyCity', this.value)" list="cityList">
                </td>
                <td>
                    <input type="number" step="0.1" value="${r.buyPrice.toFixed(1)}" onchange="updateRow(${index}, 'buyPrice', this.value)">
                </td>
                <td>
                    <input type="number" value="${r.stock || 0}" onchange="updateRow(${index}, 'stock', this.value)">
                </td>
                <td>
                    <input value="${r.sellCity}" onchange="updateRow(${index}, 'sellCity', this.value)" list="cityList">
                </td>
                <td>
                    <input type="number" step="0.1" value="${r.sellPrice.toFixed(1)}" onchange="updateRow(${index}, 'sellPrice', this.value)">
                </td>
                <td class="${profitClass}" style="font-weight:bold;">
                    ${profitSign}${rate}%
                </td>
                <td>
                    <button onclick="removeRow(${index})" style="color:red;border:none;background:none;cursor:pointer;font-size:18px;">Ã—</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        // æ·»åŠ æ•°æ®åˆ—è¡¨è¾…åŠ©è¾“å…¥
        if (!document.getElementById('itemList')) {
            const itemDatalist = document.createElement('datalist');
            itemDatalist.id = 'itemList';
            ITEMS.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                itemDatalist.appendChild(option);
            });
            document.body.appendChild(itemDatalist);
        }
        
        if (!document.getElementById('cityList')) {
            const cityDatalist = document.createElement('datalist');
            cityDatalist.id = 'cityList';
            CITIES.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                cityDatalist.appendChild(option);
            });
            document.body.appendChild(cityDatalist);
        }
        
        // å°†æ¸…æ´—åçš„æ•°æ®å­˜å›å…¨å±€å˜é‡ä¾›åˆ†æä½¿ç”¨
        window.currentRoutes = routes;
    }

    function updateRow(index, field, value) {
        if (window.currentRoutes && window.currentRoutes[index]) {
            if (field === 'name' || field === 'buyCity' || field === 'sellCity') {
                window.currentRoutes[index][field] = value;
            } else if (field === 'buyPrice' || field === 'sellPrice') {
                window.currentRoutes[index][field] = parseFloat(value) || 0;
            } else if (field === 'stock') {
                window.currentRoutes[index][field] = parseInt(value) || 0;
            }
            
            // é‡æ–°è®¡ç®—åˆ©æ¶¦ç‡
            const route = window.currentRoutes[index];
            const profit = route.sellPrice - route.buyPrice;
            const rate = ((profit / route.buyPrice) * 100).toFixed(1);
            const profitSign = profit > 0 ? '+' : '';
            
            // æ›´æ–°è¡¨æ ¼ä¸­çš„æ˜¾ç¤º
            const row = document.querySelector(`#dataTable tbody tr:nth-child(${index + 1})`);
            if (row) {
                const rateCell = row.querySelector('td:nth-child(7)');
                rateCell.textContent = `${profitSign}${rate}%`;
                rateCell.className = profit > 0 ? 'positive-profit' : 'negative-profit';
            }
        }
    }

    function removeRow(index) {
        if (window.currentRoutes && window.currentRoutes[index]) {
            window.currentRoutes.splice(index, 1);
            renderTable();
        }
    }

    function analyzeData() {
        if (!window.currentRoutes || window.currentRoutes.length === 0) {
            alert("æ²¡æœ‰å¯åˆ†æçš„æ•°æ®");
            return;
        }

        // 1. è®¡ç®—å¹¶æ’åº
        window.currentRoutes.forEach(r => {
            r.profitSingle = r.sellPrice - r.buyPrice;
            r.rate = (r.profitSingle / r.buyPrice) * 100;
            r.totalPotential = r.profitSingle * (r.stock || 1);
        });

        // æŒ‰åˆ©æ¶¦ç‡æ’åº
        const bestRoutes = [...window.currentRoutes].sort((a, b) => b.rate - a.rate);
        const best = bestRoutes[0];

        // 2. ç”Ÿæˆæ–‡å­—æŠ¥å‘Š
        let html = `<div class="best-route">ğŸ† æœ€ä½³æš´åˆ©è·¯çº¿ï¼š<br>`;
        html += `<span style="font-size: 24px;">${best.buyCity}</span> â†’ <span style="font-size: 24px;">${best.sellCity}</span><br>`;
        html += `å•†å“ï¼š<b>${best.name}</b><br>`;
        html += `ä¹°å…¥ä»·ï¼š${best.buyPrice.toFixed(1)} | å–å‡ºä»·ï¼š${best.sellPrice.toFixed(1)}<br>`;
        html += `å•æ¬¡åˆ©æ¶¦ç‡ï¼š<span style="color:#d32f2f;font-size:20px;">${best.rate.toFixed(1)}%</span> | å•ä»·å·®ï¼š${best.profitSingle > 0 ? '+' : ''}${best.profitSingle.toFixed(1)}</div>`;
        
        html += `<h4>ğŸ’¡ Top 5 æ¨èï¼š</h4><ul style="list-style:none;padding:0;">`;
        bestRoutes.slice(0, 5).forEach((r, i) => {
            const medal = i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : 'ğŸ¯';
            html += `<li style="margin-bottom:8px;padding:8px;background:${i%2===0?'#f9f9f9':'#fff'};border-radius:4px;">
                ${medal} <b>${r.name}</b>: ${r.buyCity}(${r.buyPrice.toFixed(1)}) â†’ ${r.sellCity}(${r.sellPrice.toFixed(1)}) 
                <span style="color:${r.rate>0?'#2e7d32':'#c62828'};font-weight:bold;">${r.rate>0?'+':''}${r.rate.toFixed(1)}%</span>
            </li>`;
        });
        html += `</ul>`;

        // 3. æ³¢åŠ¨åˆ†æ (å¦‚æœæœ‰ä¸¤å¼ å›¾çš„æ•°æ®)
        const sources = [...new Set(window.currentRoutes.map(r => r.source))];
        if (sources.length > 1) {
            html += `<h4>ğŸ“ˆ ä»·æ ¼/åº“å­˜æ³¢åŠ¨ç›‘æ§ (å¯¹æ¯”ä¸¤å¼ æˆªå›¾)ï¼š</h4>`;
            // åˆ†ç»„å¯¹æ¯”
            const groups = {};
            window.currentRoutes.forEach(r => {
                const key = `${r.name}-${r.sellCity}`;
                if (!groups[key]) groups[key] = [];
                groups[key].push(r);
            });

            let hasTrend = false;
            for (const [key, items] of Object.entries(groups)) {
                if (items.length >= 2) {
                    const r1 = items[0];
                    const r2 = items[1];
                    const priceDiff = r2.sellPrice - r1.sellPrice;
                    const stockDiff = (r2.stock || 0) - (r1.stock || 0);
                    
                    if (priceDiff !== 0 || stockDiff !== 0) {
                        hasTrend = true;
                        const trendColor = priceDiff > 0 ? '#c62828' : '#2e7d32';
                        const trendIcon = priceDiff > 0 ? 'ğŸ“ˆ' : priceDiff < 0 ? 'ğŸ“‰' : 'â¡ï¸';
                        const stockIcon = stockDiff > 0 ? 'ğŸ“¦â†‘' : stockDiff < 0 ? 'ğŸ“¦â†“' : 'ğŸ“¦';
                        
                        html += `<div style="margin-bottom:5px;padding:5px;background:#f5f5f5;border-radius:4px;">
                            <b>${key.split('-')[0]}</b> â†’ ${key.split('-')[1]}: 
                            ä»·æ ¼ ${trendIcon} <span style="color:${trendColor}">${priceDiff > 0 ? '+' : ''}${priceDiff.toFixed(1)}</span> 
                            ${stockDiff !== 0 ? `| åº“å­˜ ${stockIcon} ${stockDiff > 0 ? '+' : ''}${stockDiff}` : ''}
                        </div>`;
                    }
                }
            }
            if (!hasTrend) html += "<p>æœªæ£€æµ‹åˆ°æ˜æ˜¾æ³¢åŠ¨ï¼Œæˆ–æ•°æ®æœªå¯¹é½ã€‚</p>";
        }

        // 4. ç»Ÿè®¡ä¿¡æ¯
        const profitableRoutes = window.currentRoutes.filter(r => r.rate > 0);
        const avgProfit = profitableRoutes.length > 0 ? 
            profitableRoutes.reduce((sum, r) => sum + r.rate, 0) / profitableRoutes.length : 0;
        
        html += `<h4>ğŸ“Š ç»Ÿè®¡æ¦‚è§ˆ</h4>`;
        html += `<p>å…±åˆ†æ ${window.currentRoutes.length} æ¡è·¯çº¿ï¼Œå…¶ä¸­ ${profitableRoutes.length} æ¡ç›ˆåˆ©<br>`;
        html += `å¹³å‡åˆ©æ¶¦ç‡: <b>${avgProfit.toFixed(1)}%</b></p>`;

        document.getElementById('analysisContent').innerHTML = html;
        document.getElementById('resultSection').style.display = 'block';

        // 5. ç»˜å›¾
        renderChart();
        document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
    }

    function renderChart() {
        const ctx = document.getElementById('trendChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();

        // å‡†å¤‡æ•°æ®ï¼šå–å‰ 8 ä¸ªå•†å“çš„åˆ©æ¶¦ç‡åˆ†å¸ƒ
        const topRoutes = [...window.currentRoutes]
            .filter(r => r.rate > 0)
            .sort((a, b) => b.rate - a.rate)
            .slice(0, 8);
        
        if (topRoutes.length === 0) {
            document.getElementById('trendChart').style.display = 'none';
            return;
        }
        
        document.getElementById('trendChart').style.display = 'block';
        
        const labels = topRoutes.map(r => `${r.name}\n${r.buyCity}â†’${r.sellCity}`);
        const dataRate = topRoutes.map(r => r.rate);
        const dataPrice = topRoutes.map(r => r.sellPrice);
        const dataColors = topRoutes.map(r => r.rate > 30 ? '#d32f2f' : r.rate > 20 ? '#f57c00' : '#2e7d32');

        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'åˆ©æ¶¦ç‡ (%)',
                        data: dataRate,
                        backgroundColor: dataColors,
                        borderColor: dataColors.map(c => c.replace('0.6', '1')),
                        borderWidth: 1,
                        yAxisID: 'y',
                        barPercentage: 0.6
                    },
                    {
                        label: 'å–å‡ºå•ä»·',
                        data: dataPrice,
                        type: 'line',
                        borderColor: '#5d4037',
                        borderWidth: 3,
                        backgroundColor: 'rgba(93, 64, 55, 0.1)',
                        pointBackgroundColor: '#5d4037',
                        pointRadius: 5,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                if (context.datasetIndex === 0) {
                                    return `åˆ©æ¶¦ç‡: ${context.parsed.y.toFixed(1)}%`;
                                } else {
                                    return `å–å‡ºä»·: ${context.parsed.y.toFixed(1)}`;
                                }
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        }
                    },
                    y: { 
                        type: 'linear', 
                        display: true, 
                        position: 'left', 
                        title: {
                            display: true, 
                            text: 'åˆ©æ¶¦ç‡ %',
                            font: {
                                weight: 'bold'
                            }
                        },
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    },
                    y1: { 
                        type: 'linear', 
                        display: true, 
                        position: 'right', 
                        grid: {
                            drawOnChartArea: false
                        }, 
                        title: {
                            display: true, 
                            text: 'å–å‡ºä»·æ ¼',
                            font: {
                                weight: 'bold'
                            }
                        }
                    }
                }
            }
        });
    }
</script>

</body>
</html>
