<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸‰å›½å†°æ²³Â·è·‘å•†è®¡ç®—å™¨ (ç²¾å‡†ç‰ˆ)</title>
    <style>
        :root { --primary: #2575fc; --bg: #f5f5f5; --text: #333; --success: #2e7d32; --danger: #d32f2f; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding: 10px; color: var(--text); }
        .container { max-width: 100%; margin: 0 auto; background: #fff; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow-x: auto; }
        h1 { text-align: center; padding: 15px; background: linear-gradient(135deg, #6a11cb, #2575fc); color: #fff; margin: 0; font-size: 18px; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { padding: 8px 5px; text-align: center; border-bottom: 1px solid #eee; font-size: 12px; }
        th { background: #f8f9fa; font-weight: 600; position: sticky; top: 0; z-index: 10; white-space: nowrap; }
        input, select { width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 12px; }
        input:focus, select:focus { outline: none; border-color: var(--primary); }
        
        .custom-select-wrapper { position: relative; width: 100%; }
        .custom-select-input { cursor: text; background: #fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 12 12'%3E%3Cpath fill='%23999' d='M6 8L1 3h10z'/%3E%3C/svg%3E") no-repeat right 8px center; padding-right: 20px; }
        .custom-options { position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid var(--primary); border-top: 0; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 8px rgba(0,0,0,0.1); display: none; }
        .custom-select-wrapper.open .custom-options { display: block; }
        .custom-option { padding: 8px; cursor: pointer; display: flex; justify-content: space-between; font-size: 12px; }
        .custom-option:hover { background: #eef2ff; color: var(--primary); }
        .weight-tag { font-size: 10px; background: #eee; padding: 1px 4px; border-radius: 3px; }
        .no-results { padding: 8px; text-align: center; color: #999; font-style: italic; display: none; }
        
        .profit-cell { font-weight: bold; font-size: 13px; }
        .status-ok { color: var(--success); }
        .status-warn { color: #f57c00; }
        .status-error { color: var(--danger); }
        
        .btn-add { background: var(--primary); color: #fff; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 13px; margin: 10px auto; display: block; }
        .btn-del { background: #ff5252; color: #fff; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .footer { text-align: center; padding: 10px; font-size: 11px; color: #666; background: #f8f9fa; }
        .note { font-size: 11px; color: #666; text-align: center; padding: 8px; background: #fff3cd; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§Š ä¸‰å›½å†°æ²³Â·è·‘å•†è®¡ç®—å™¨ (ç²¾å‡†ç‰ˆ)</h1>
        <div class="note">ğŸ’¡ <strong>ç”¨æ³•ï¼š</strong>å¦‚æœè‡ªåŠ¨è®¡ç®—çš„åˆ©æ¶¦ä¸å¯¹ï¼Œè¯·åœ¨â€œäº¤æ˜“æ•°é‡â€æ <strong>æ‰‹åŠ¨å¡«å…¥</strong>æ¸¸æˆé‡Œå®é™…èƒ½ä¹°çš„æ•°é‡ã€‚</div>
        <table id="tradingTable">
            <thead>
                <tr>
                    <th style="width: 12%;">å•†å“</th>
                    <th style="width: 8%;">ä¹°å…¥</th>
                    <th style="width: 8%;">å–å‡º</th>
                    <th style="width: 8%;">å·²å </th>
                    <th style="width: 8%;">æ€»é‡</th>
                    <th style="width: 8%;">å•é‡</th>
                    <th style="width: 10%;">äº¤æ˜“æ•°é‡<br><span style="font-weight:normal;font-size:10px;color:#888">(ç•™ç©º=è‡ªåŠ¨ç®—)</span></th>
                    <th style="width: 8%;">ç¨ç‡</th>
                    <th style="width: 12%;">é¢„è®¡åˆ©æ¶¦</th>
                    <th style="width: 8%;">çŠ¶æ€</th>
                    <th style="width: 8%;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <button class="btn-add" onclick="addRow()">+ æ·»åŠ ä¸€è¡Œ</button>
        <div class="footer">è¾“å…¥æ‹¼éŸ³é¦–å­—æ¯æœç´¢ (å¦‚ "tks"=é“œçŸ¿çŸ³)</div>
    </div>

    <script>
        const products = [
            {n:"é»åœŸ",w:15,p:"nian tu"}, {n:"æ£‰èŠ±",w:13,p:"mian hua"}, {n:"èŒ¶å¶",w:13,p:"cha ye"},
            {n:"é“çŸ¿çŸ³",w:34,p:"tie kuang shi"}, {n:"é“œçŸ¿çŸ³",w:35,p:"tong kuang shi"}, {n:"è°·ç‰©",w:10,p:"gu wu"},
            {n:"è‘¡è„",w:10,p:"pu tao"}, {n:"ç¡¬æœ¨",w:15,p:"ying mu"}, {n:"è¯æ",w:11,p:"yao cai"},
            {n:"é¦™æ–™",w:10,p:"xiang liao"}, {n:"æ¯›çš®",w:18,p:"mao pi"}, {n:"èœ‚èœœ",w:29,p:"feng mi"},
            {n:"ç›",w:35,p:"yan"}, {n:"ç±³é…’",w:30,p:"mi jiu"}, {n:"é™¶å™¨",w:30,p:"tao qi"},
            {n:"è‘¡è„é…’",w:30,p:"pu tao jiu"}, {n:"å…µå™¨",w:52,p:"bing qi"}, {n:"é“œå™¨",w:55,p:"tong qi"},
            {n:"å·¥å…·",w:50,p:"gong ju"}, {n:"å¸ƒå¸›",w:16,p:"bu bo"}, {n:"èœ€é”¦",w:10,p:"shu jin"},
            {n:"æ¼†å™¨",w:32,p:"qi qi"}, {n:"ç‰å™¨",w:32,p:"yu qi"}, {n:"æµ·å—çç ",w:12,p:"hai nan zhen zhu"},
            {n:"é‡‘é“¶å™¨",w:27,p:"jin yin qi"}
        ];

        window.onload = () => {
            // ç¤ºä¾‹ï¼šè°·ç‰©ï¼Œæ‰‹åŠ¨å¡«å…¥æ•°é‡ 742 æ¥åŒ¹é…æ¸¸æˆæ•°æ®
            addRow("è°·ç‰©", 14.1, 17.6, 0, 6000, 742, 0.2); 
            addRow("èŒ¶å¶", 58.4, 73.1, 247, 7000, "", 0.1);
        };

        function addRow(defName="", buy="", sell="", used="", max="", qty="", taxVal="") {
            const tbody = document.querySelector('#tradingTable tbody');
            const tr = document.createElement('tr');
            
            let taxOpts = `<option value="0">0%</option>`;
            for(let i=10; i<=90; i++) taxOpts += `<option value="${i/100}" ${i/100==taxVal?'selected':''}>${i}%</option>`;

            tr.innerHTML = `
                <td><div class="custom-select-wrapper" data-def="${defName}"><input type="text" class="custom-select-input" placeholder="æœ..." autocomplete="off"><div class="custom-options"></div></div></td>
                <td><input type="number" class="buy-price" value="${buy}" step="0.1"></td>
                <td><input type="number" class="sell-price" value="${sell}" step="0.1"></td>
                <td><input type="number" class="used-weight" value="${used}"></td>
                <td><input type="number" class="max-weight" value="${max}"></td>
                <td><input type="number" class="item-weight" value="" readonly style="background:#f0f0f0;"></td>
                <td><input type="number" class="plan-qty" value="${qty}" placeholder="è‡ªåŠ¨" step="1"></td>
                <td><select class="tax-rate">${taxOpts}</select></td>
                <td class="profit-cell">0.00</td>
                <td class="status-cell">-</td>
                <td><button class="btn-del" onclick="this.closest('tr').remove();if(!document.querySelectorAll('tbody tr').length)addRow();">Ã—</button></td>
            `;
            tbody.appendChild(tr);
            initSelect(tr.querySelector('.custom-select-wrapper'));
            if(defName) setTimeout(()=>{
                const inp = tr.querySelector('.custom-select-input');
                inp.value = defName;
                selectOpt(tr.querySelector('.custom-select-wrapper'), defName, true);
            }, 0);
            tr.querySelectorAll('input,select').forEach(i=>i.addEventListener('input',()=>calc(tr)));
        }

        function initSelect(wrap) {
            const inp = wrap.querySelector('.custom-select-input');
            const optsDiv = wrap.querySelector('.custom-options');
            const row = wrap.closest('tr');
            const wInp = row.querySelector('.item-weight');
            
            products.forEach(prod => {
                const d = document.createElement('div');
                d.className = 'custom-option';
                d.innerHTML = `<span>${prod.n}</span><span class="weight-tag">${prod.w}</span>`;
                d.dataset.v = prod.n; d.dataset.w = prod.w; d.dataset.p = prod.p;
                optsDiv.appendChild(d);
            });
            const noRes = document.createElement('div'); noRes.className='no-results'; noRes.textContent='æ— åŒ¹é…'; optsDiv.appendChild(noRes);

            inp.addEventListener('focus', e=>{ e.stopPropagation(); closeAll(); wrap.classList.add('open'); filter(inp.value, optsDiv, noRes); });
            inp.addEventListener('input', e=>{ e.stopPropagation(); wrap.classList.add('open'); filter(inp.value, optsDiv, noRes); });
            optsDiv.addEventListener('mousedown', e=>{
                e.preventDefault();
                const t = e.target.classList.contains('custom-option')?e.target:e.target.parentElement;
                if(t.classList.contains('custom-option')) selectOpt(wrap, t.dataset.v, true);
            });
            document.addEventListener('click', e=>{ if(!wrap.contains(e.target)) wrap.classList.remove('open'); });
            
            wInp.addEventListener('focus', function(){ this.style.background='#fff'; this.style.borderColor='#ffa000'; });
            wInp.addEventListener('blur', function(){ if(!this.value) this.style.background='#f0f0f0'; });
        }

        function filter(q, container, noRes) {
            const qs = q.toLowerCase().trim();
            let has = false;
            container.querySelectorAll('.custom-option').forEach(opt => {
                const n = opt.dataset.v, p = opt.dataset.p;
                const match = n.includes(qs) || p.replace(/\s/g,'').includes(qs) || p.split(' ').map(x=>x[0]).join('').includes(qs);
                opt.style.display = match ? 'flex' : 'none';
                if(match) has = true;
            });
            noRes.style.display = has ? 'none' : 'block';
        }

        function selectOpt(wrap, val, force) {
            const inp = wrap.querySelector('.custom-select-input');
            const row = wrap.closest('tr');
            const wInp = row.querySelector('.item-weight');
            const prod = products.find(x=>x.n===val);
            inp.value = val; wrap.classList.remove('open');
            wrap.querySelectorAll('.custom-option').forEach(o=>o.classList.toggle('selected', o.dataset.v===val));
            if(prod && force) {
                wInp.value = prod.w;
                wInp.style.background = '#e8f5e9';
                setTimeout(()=>{ if(document.activeElement!==wInp) wInp.style.background='#f0f0f0'; }, 500);
                calc(row);
            }
        }

        function closeAll() { document.querySelectorAll('.custom-select-wrapper').forEach(w=>w.classList.remove('open')); }

        function calc(row) {
            const b = parseFloat(row.querySelector('.buy-price').value)||0;
            const s = parseFloat(row.querySelector('.sell-price').value)||0;
            const u = parseFloat(row.querySelector('.used-weight').value)||0;
            const m = parseFloat(row.querySelector('.max-weight').value)||0;
            let w = parseFloat(row.querySelector('.item-weight').value);
            const t = parseFloat(row.querySelector('.tax-rate').value)||0;
            const qtyInput = row.querySelector('.plan-qty').value.trim();
            
            if(!w) w=1;
            
            let quantity = 0;
            let statusMsg = "";
            let statusClass = "status-ok";

            if (qtyInput === "") {
                // æ¨¡å¼Aï¼šè‡ªåŠ¨è®¡ç®— (æ€»é‡ - å·²å ) / å•é‡
                const avail = Math.max(0, m - u);
                quantity = Math.floor(avail / w);
                statusMsg = `è‡ªåŠ¨ (${quantity}ä¸ª)`;
                if (quantity === 0 && avail > 0) statusMsg = "å•é‡è¿‡å¤§";
            } else {
                // æ¨¡å¼Bï¼šæŒ‰ç”¨æˆ·è¾“å…¥çš„æ•°é‡
                quantity = parseInt(qtyInput);
                const totalWeight = quantity * w;
                if (totalWeight + u > m) {
                    statusMsg = `è¶…é‡! (${totalWeight+u}/${m})`;
                    statusClass = "status-error";
                } else {
                    const usage = (((totalWeight+u)/m)*100).toFixed(1);
                    statusMsg = `å ç”¨ ${usage}%`;
                    statusClass = "status-ok";
                }
            }

            const profit = (s - b) * quantity * (1 - t);
            const profitCell = row.querySelector('.profit-cell');
            const statusCell = row.querySelector('.status-cell');
            
            profitCell.textContent = profit.toLocaleString('zh-CN', {minimumFractionDigits:2, maximumFractionDigits:2});
            profitCell.style.color = profit >= 0 ? 'var(--success)' : 'var(--danger)';
            
            statusCell.textContent = statusMsg;
            statusCell.className = "status-cell " + statusClass;
        }
    </script>
</body>
</html>
