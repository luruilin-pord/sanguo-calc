<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‰å›½å†°æ²³Â·æ™ºèƒ½è·‘å•†åˆ†æå™¨ (OCR ç‰ˆ)</title>
    <!-- å¼•å…¥ Tesseract.js ç”¨äºæœ¬åœ° OCR è¯†åˆ« -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <!-- å¼•å…¥ Chart.js ç”¨äºç»˜å›¾ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #d4a017; --bg: #f4f1ea; --card: #fffdf5; --text: #5d4037; --accent: #8b5a2b; }
        body { font-family: 'Microsoft YaHei', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        h1 { text-align: center; color: var(--accent); text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        
        /* ä¸Šä¼ åŒºåŸŸ */
        .upload-zone {
            border: 3px dashed var(--accent); background: var(--card); border-radius: 15px;
            padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s;
            margin-bottom: 20px; position: relative;
        }
        .upload-zone:hover { background: #fff; border-color: var(--primary); }
        .upload-icon { font-size: 50px; margin-bottom: 10px; display: block; }
        
        /* è¿›åº¦æ¡ */
        .progress-container { display: none; margin-top: 15px; }
        .progress-bar { width: 100%; height: 10px; background: #ddd; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }
        
        /* è¡¨æ ¼æ ·å¼ */
        .table-wrapper { overflow-x: auto; background: var(--card); border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: var(--accent); color: #fff; padding: 12px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        tr:hover { background: #fff8e1; }
        input { width: 90%; padding: 5px; border: 1px solid #ccc; border-radius: 4px; background: #fff; }
        .highlight-row { background: #e8f5e9 !important; border-left: 5px solid #2e7d32; }
        
        /* æŒ‰é’® */
        .btn { background: var(--primary); color: #fff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; display: block; margin: 20px auto; }
        .btn:hover { background: var(--accent); }
        
        /* ç»“æœå¡ç‰‡ */
        .result-card { background: var(--card); padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; margin-bottom: 20px; }
        .best-route { font-size: 18px; color: #d32f2f; font-weight: bold; margin-bottom: 10px; }
        
        /* å›¾è¡¨ */
        .chart-container { position: relative; height: 300px; width: 100%; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ§Š ä¸‰å›½å†°æ²³Â·æ™ºèƒ½è·‘å•†åˆ†æå™¨</h1>
    <p style="text-align:center; color:#666;">ä¸Šä¼  1-2 å¼ æ¸¸æˆæˆªå›¾ï¼Œè‡ªåŠ¨è¯†åˆ«ä»·æ ¼ã€åº“å­˜å¹¶è®¡ç®—æœ€ä½³è·¯çº¿</p>

    <!-- ä¸Šä¼ åŒº -->
    <div class="upload-zone" id="dropZone">
        <span class="upload-icon">ğŸ“¸</span>
        <h3>ç‚¹å‡»æˆ–æ‹–æ‹½æˆªå›¾åˆ°è¿™é‡Œ</h3>
        <p style="font-size:12px; color:#999;">æ”¯æŒåŒæ—¶ä¸Šä¼  2 å¼ ä»¥å¯¹æ¯”ä»·æ ¼æ³¢åŠ¨</p>
        <input type="file" id="fileInput" multiple accept="image/*" style="display:none">
        
        <div class="progress-container" id="progressContainer">
            <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px;">
                <span id="statusText">æ­£åœ¨è¯†åˆ«...</span>
                <span id="percentText">0%</span>
            </div>
            <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        </div>
    </div>

    <!-- æ•°æ®æ ¡å¯¹è¡¨ -->
    <div id="dataSection" style="display:none;">
        <h3>ğŸ“ è¯†åˆ«æ•°æ®æ ¡å¯¹ (è¯·æ£€æŸ¥æ•°å­—æ˜¯å¦æ­£ç¡®)</h3>
        <div class="table-wrapper">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>å•†å“</th>
                        <th>å½“å‰åŸæ± </th>
                        <th>ä¹°å…¥ä»·</th>
                        <th>å‰©ä½™é‡</th>
                        <th>ç›®æ ‡åŸæ±  (ä¼ é—»)</th>
                        <th>å–å‡ºä»· (ä¼ é—»)</th>
                        <th>åˆ©æ¶¦ç‡</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <button class="btn" onclick="analyzeData()">ğŸš€ å¼€å§‹åˆ†æä¸ç»˜å›¾</button>
    </div>

    <!-- åˆ†æç»“æœ -->
    <div id="resultSection" class="result-card">
        <h3>ğŸ“Š åˆ†ææŠ¥å‘Š</h3>
        <div id="analysisContent"></div>
        <div class="chart-container">
            <canvas id="trendChart"></canvas>
        </div>
    </div>
</div>

<script>
    // æ¸¸æˆæ•°æ®å­—å…¸ï¼Œè¾…åŠ© OCR ä¿®æ­£
    const CITIES = ["æˆˆå±…", "æˆçºª", "å¤©æ°´", "è™å¨", "æ¸Šæ³‰", "å¯Œå¹³", "ç¥–å‰", "é‡‘åŸ", "ç™½åœŸ", "è‚¤æ–½", "å§‘è‡§", "å¹³è¥„", "è¡—äº­", "ä¸´æˆ"];
    const ITEMS = ["é»åœŸ", "æ£‰èŠ±", "è°·ç‰©", "è‘¡è„", "ç¡¬æœ¨", "è¯æ", "é¦™æ–™", "æ¯›çš®", "èœ‚èœœ", "ç›", "ç±³é…’", "é™¶å™¨", "è‘¡è„é…’", "å…µå™¨", "é“œå™¨", "å·¥å…·", "å¸ƒå¸›", "èœ€é”¦", "æ¼†å™¨", "ç‰å™¨", "æµ·å—çç ", "é‡‘é“¶å™¨", "é“œçŸ¿çŸ³", "é“çŸ¿çŸ³", "èŒ¶å¶"];

    let rawData = [];
    let chartInstance = null;

    // åˆå§‹åŒ–æ‹–æ‹½
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.style.background = '#fff'; });
    dropZone.addEventListener('dragleave', () => dropZone.style.background = 'var(--card)');
    dropZone.addEventListener('drop', e => {
        e.preventDefault();
        dropZone.style.background = 'var(--card)';
        handleFiles(e.dataTransfer.files);
    });
    fileInput.addEventListener('change', e => handleFiles(e.target.files));

    async function handleFiles(files) {
        if (files.length === 0) return;
        if (files.length > 2) { alert("æœ€å¤šä¸Šä¼  2 å¼ è¿›è¡Œå¯¹æ¯”"); return; }

        rawData = [];
        document.getElementById('dataSection').style.display = 'none';
        document.getElementById('resultSection').style.display = 'none';
        document.getElementById('progressContainer').style.display = 'block';

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            updateProgress(`æ­£åœ¨æ‰«æå›¾ç‰‡ ${i+1}/${files.length}...`, 0);
            
            try {
                // ä½¿ç”¨ Tesseract è¿›è¡Œä¸­æ–‡è¯†åˆ«
                const { data: { text } } = await Tesseract.recognize(file, 'chi_sim', {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            updateProgress(`è¯†åˆ«ä¸­ï¼š${Math.round(m.progress * 100)}%`, m.progress * 100);
                        }
                    }
                });
                
                parseGameText(text, `æˆªå›¾${i+1}`);
            } catch (err) {
                console.error(err);
                alert("è¯†åˆ«å¤±è´¥ï¼Œè¯·ç¡®ä¿å›¾ç‰‡æ¸…æ™°");
            }
        }

        updateProgress("è¯†åˆ«å®Œæˆï¼Œè¯·æ ¡å¯¹æ•°æ®", 100);
        setTimeout(() => {
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('dataSection').style.display = 'block';
            renderTable();
        }, 1000);
    }

    function updateProgress(text, percent) {
        document.getElementById('statusText').innerText = text;
        document.getElementById('percentText').innerText = Math.round(percent) + '%';
        document.getElementById('progressFill').style.width = percent + '%';
    }

    // æ ¸å¿ƒè§£æé€»è¾‘ï¼šä» OCR æ–‡æœ¬ä¸­æå–ç»“æ„åŒ–æ•°æ®
    function parseGameText(text, sourceName) {
        const lines = text.split('\n');
        let currentItem = null;
        let currentCity = "æœªçŸ¥"; // é»˜è®¤å½“å‰åŸå¸‚ï¼Œæœ€å¥½ä»æ ‡é¢˜æ è¯†åˆ«ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†

        // å°è¯•ä»ç¬¬ä¸€è¡Œè¯†åˆ«åŸå¸‚å (ä¾‹å¦‚ "æˆˆå±…åŠå¸‚")
        const titleMatch = text.match(/([A-Za-z\u4e00-\u9fa5]{2}) åŠå¸‚/);
        if (titleMatch && titleMatch[1]) currentCity = titleMatch[1];

        lines.forEach(line => {
            line = line.trim();
            if (!line) return;

            // 1. è¯†åˆ«å•†å“å¤´ (ä¾‹å¦‚ "é»åœŸ ... å‰©ä½™ï¼š20750")
            // é€»è¾‘ï¼šæ‰¾åˆ°å·²çŸ¥å•†å“å
            let foundItem = ITEMS.find(item => line.includes(item));
            if (foundItem) {
                currentItem = { name: foundItem, source: sourceName, buyCity: currentCity };
                // æå–å‰©ä½™é‡
                const stockMatch = line.match(/å‰©ä½™ [::]\s*(\d+)/);
                if (stockMatch) currentItem.stock = parseInt(stockMatch[1]);
                rawData.push(currentItem);
                return;
            }

            // 2. è¯†åˆ«ä¹°å…¥ä»· (ä¾‹å¦‚ "ä¹°å…¥ä»·æ ¼ 17.3")
            if (currentItem && line.includes("ä¹°å…¥ä»·æ ¼")) {
                const priceMatch = line.match(/(\d+\.?\d*)/);
                if (priceMatch) currentItem.buyPrice = parseFloat(priceMatch[1]);
                return;
            }

            // 3. è¯†åˆ«ä¼ é—» (ä¾‹å¦‚ "ä¼ é—» 1:æ®è¯´ [ç¥–å‰] çš„å–å‡ºä»·æ ¼ä¸º 24.5")
            if (currentItem && (line.includes("ä¼ é—»") || line.includes("æ®è¯´"))) {
                const cityMatch = line.match(/\[(.*?)\]/);
                const priceMatch = line.match(/ä»·æ ¼ä¸º [::]?\s*(\d+\.?\d*)/);
                
                if (cityMatch && priceMatch) {
                    // ä¸ºå½“å‰å•†å“åˆ›å»ºä¸€ä¸ªæ–°çš„é”€å”®è·¯çº¿è®°å½•
                    rawData.push({
                        name: currentItem.name,
                        source: sourceName,
                        buyCity: currentItem.buyCity,
                        buyPrice: currentItem.buyPrice,
                        stock: currentItem.stock,
                        sellCity: cityMatch[1],
                        sellPrice: parseFloat(priceMatch[1])
                    });
                }
            }
        });
    }

    function renderTable() {
        const tbody = document.querySelector('#dataTable tbody');
        tbody.innerHTML = '';
        
        // è¿‡æ»¤æ‰æ²¡æœ‰å–å‡ºä»·çš„çº¯å•†å“å¤´ä¿¡æ¯ï¼Œåªå±•ç¤ºå¯è®¡ç®—çš„è·¯çº¿
        const routes = rawData.filter(r => r.sellPrice);

        routes.forEach((r, index) => {
            const profit = r.sellPrice - r.buyPrice;
            const rate = ((profit / r.buyPrice) * 100).toFixed(1);
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input value="${r.name}" onchange="updateRow(${index}, 'name', this.value)"></td>
                <td><input value="${r.buyCity}" onchange="updateRow(${index}, 'buyCity', this.value)"></td>
                <td><input type="number" step="0.1" value="${r.buyPrice}" onchange="updateRow(${index}, 'buyPrice', this.value)"></td>
                <td><input type="number" value="${r.stock}" onchange="updateRow(${index}, 'stock', this.value)"></td>
                <td><input value="${r.sellCity}" onchange="updateRow(${index}, 'sellCity', this.value)"></td>
                <td><input type="number" step="0.1" value="${r.sellPrice}" onchange="updateRow(${index}, 'sellPrice', this.value)"></td>
                <td style="font-weight:bold; color:${rate>30?'red':'green'}">${rate}%</td>
                <td><button onclick="removeRow(${index})" style="color:red;border:none;background:none;cursor:pointer;">Ã—</button></td>
            `;
            tbody.appendChild(tr);
        });
        
        // å°†æ¸…æ´—åçš„æ•°æ®å­˜å›å…¨å±€å˜é‡ä¾›åˆ†æä½¿ç”¨
        window.currentRoutes = routes;
    }

    function updateRow(index, field, value) {
        // æ³¨æ„ï¼šè¿™é‡Œçš„ index å¯¹åº”çš„æ˜¯è¿‡æ»¤åçš„ routes æ•°ç»„ï¼Œéœ€è¦æ˜ å°„å› rawData æˆ–è€…ç›´æ¥ä½¿ç”¨ currentRoutes
        // ä¸ºç®€åŒ–ï¼Œæˆ‘ä»¬ç›´æ¥æ›´æ–° currentRoutesï¼Œå› ä¸º renderTable æ˜¯åŸºäºå®ƒçš„
        if(window.currentRoutes[index]) {
            window.currentRoutes[index][field] = (field === 'name' || field === 'buyCity' || field === 'sellCity') ? value : parseFloat(value);
        }
    }

    function removeRow(index) {
        window.currentRoutes.splice(index, 1);
        renderTable();
    }

    function analyzeData() {
        if (!window.currentRoutes || window.currentRoutes.length === 0) return alert("æ²¡æœ‰å¯åˆ†æçš„æ•°æ®");

        // 1. è®¡ç®—å¹¶æ’åº
        window.currentRoutes.forEach(r => {
            r.profitSingle = r.sellPrice - r.buyPrice;
            r.rate = (r.profitSingle / r.buyPrice) * 100;
            // å‡è®¾æ»¡è½½ï¼Œæ ¹æ®è´Ÿé‡ä¼°ç®—æ•°é‡ï¼Ÿè¿™é‡Œç®€åŒ–ä¸ºç›´æ¥ç”¨å‰©ä½™é‡ä»£è¡¨å¸‚åœºå®¹é‡
            r.totalPotential = r.profitSingle * r.stock; 
        });

        // æŒ‰åˆ©æ¶¦ç‡æ’åº
        const bestRoutes = [...window.currentRoutes].sort((a, b) => b.rate - a.rate);
        const best = bestRoutes[0];

        // 2. ç”Ÿæˆæ–‡å­—æŠ¥å‘Š
        let html = `<div class="best-route">ğŸ† æœ€ä½³æš´åˆ©è·¯çº¿ï¼š<br>${best.buyCity} ä¹°å…¥ [${best.name}] -> ${best.sellCity} å–å‡º<br>å•æ¬¡åˆ©æ¶¦ç‡ï¼š${best.rate.toFixed(1)}% | å•ä»·å·®ï¼š${best.profitSingle.toFixed(1)}</div>`;
        
        html += `<h4>ğŸ’¡ Top 3 æ¨èï¼š</h4><ul>`;
        bestRoutes.slice(0, 3).forEach((r, i) => {
            html += `<li>${i+1}. <b>${r.name}</b>: ${r.buyCity}(${r.buyPrice}) â†’ ${r.sellCity}(${r.sellPrice}) [${r.rate.toFixed(1)}%]</li>`;
        });
        html += `</ul>`;

        // 3. æ³¢åŠ¨åˆ†æ (å¦‚æœæœ‰ä¸¤å¼ å›¾çš„æ•°æ®)
        const sources = [...new Set(window.currentRoutes.map(r => r.source))];
        if (sources.length > 1) {
            html += `<h4>ğŸ“ˆ ä»·æ ¼/åº“å­˜æ³¢åŠ¨ç›‘æ§ (å¯¹æ¯”ä¸¤å¼ æˆªå›¾)ï¼š</h4>`;
            // åˆ†ç»„å¯¹æ¯”
            const groups = {};
            window.currentRoutes.forEach(r => {
                const key = `${r.name}-${r.sellCity}`; // ä»¥å•†å“ + ç›®çš„åœ°ä¸ºé”®
                if (!groups[key]) groups[key] = [];
                groups[key].push(r);
            });

            let hasTrend = false;
            for (const [key, items] of Object.entries(groups)) {
                if (items.length >= 2) {
                    const r1 = items[0]; // å›¾ 1
                    const r2 = items[1]; // å›¾ 2
                    const priceDiff = r2.sellPrice - r1.sellPrice;
                    const stockDiff = r2.stock - r1.stock;
                    
                    if (priceDiff !== 0 || stockDiff !== 0) {
                        hasTrend = true;
                        const trendColor = priceDiff > 0 ? 'red' : 'green';
                        const trendIcon = priceDiff > 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';
                        html += `<div style="margin-bottom:5px;">
                            <b>${key}</b>: ä»·æ ¼ ${trendIcon}${priceDiff > 0 ? '+' : ''}${priceDiff.toFixed(1)} 
                            ${stockDiff !== 0 ? `| åº“å­˜ ${stockDiff > 0 ? '+' : ''}${stockDiff}` : ''}
                        </div>`;
                    }
                }
            }
            if (!hasTrend) html += "<p>æœªæ£€æµ‹åˆ°æ˜æ˜¾æ³¢åŠ¨ï¼Œæˆ–æ•°æ®æœªå¯¹é½ã€‚</p>";
        }

        document.getElementById('analysisContent').innerHTML = html;
        document.getElementById('resultSection').style.display = 'block';

        // 4. ç»˜å›¾
        renderChart();
        document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
    }

    function renderChart() {
        const ctx = document.getElementById('trendChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();

        // å‡†å¤‡æ•°æ®ï¼šå–å‰ 5 ä¸ªå•†å“çš„åˆ©æ¶¦ç‡åˆ†å¸ƒ
        const labels = window.currentRoutes.slice(0, 10).map(r => `${r.name}(${r.sellCity})`);
        const dataRate = window.currentRoutes.slice(0, 10).map(r => r.rate);
        const dataPrice = window.currentRoutes.slice(0, 10).map(r => r.sellPrice);

        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'åˆ©æ¶¦ç‡ (%)',
                        data: dataRate,
                        backgroundColor: 'rgba(212, 160, 23, 0.6)',
                        borderColor: 'rgba(212, 160, 23, 1)',
                        borderWidth: 1,
                        yAxisID: 'y'
                    },
                    {
                        label: 'å–å‡ºå•ä»·',
                        data: dataPrice,
                        type: 'line',
                        borderColor: '#d32f2f',
                        borderWidth: 2,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { type: 'linear', display: true, position: 'left', title: {display:true, text:'åˆ©æ¶¦ç‡ %'} },
                    y1: { type: 'linear', display: true, position: 'right', grid: {drawOnChartArea:false}, title: {display:true, text:'ä»·æ ¼'} }
                }
            }
        });
    }
</script>

</body>
</html>
