<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‰å›½å†°æ²³Â·æ™ºèƒ½è·‘å•†åˆ†æå™¨ (å¿«é€Ÿè¯†åˆ«ç‰ˆ)</title>
    <!-- å¼•å…¥è½»é‡çº§OCRåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <!-- å¼•å…¥ Chart.js ç”¨äºç»˜å›¾ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #d4a017; --bg: #f4f1ea; --card: #fffdf5; --text: #5d4037; --accent: #8b5a2b; }
        body { font-family: 'Microsoft YaHei', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        h1 { text-align: center; color: var(--accent); text-shadow: 1px 1px 2px rgba(0,0,0,0.2); margin-bottom: 10px; }
        
        /* ä¸Šä¼ åŒºåŸŸ */
        .upload-zone {
            border: 3px dashed var(--accent); background: var(--card); border-radius: 15px;
            padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s;
            margin-bottom: 20px; position: relative;
        }
        .upload-zone:hover { background: #fff; border-color: var(--primary); }
        .upload-zone.dragover { background: #fff8e1; border-color: var(--primary); }
        .upload-icon { font-size: 50px; margin-bottom: 10px; display: block; }
        
        /* ä¸Šä¼ é€‰é¡¹ */
        .upload-options {
            display: flex; justify-content: center; gap: 20px; margin: 20px 0;
        }
        .option-card {
            background: #fff; border: 2px solid #ddd; border-radius: 10px;
            padding: 15px; text-align: center; cursor: pointer; transition: all 0.3s;
            flex: 1; max-width: 200px;
        }
        .option-card:hover, .option-card.active {
            border-color: var(--primary); background: #fff8e1;
        }
        .option-icon { font-size: 30px; margin-bottom: 10px; }
        
        /* è¿›åº¦æ¡ */
        .progress-container { display: none; margin-top: 15px; }
        .progress-bar { width: 100%; height: 10px; background: #ddd; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), #f0c040); width: 0%; transition: width 0.3s; }
        
        /* è¡¨æ ¼æ ·å¼ */
        .table-wrapper { overflow-x: auto; background: var(--card); border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background: var(--accent); color: #fff; padding: 12px; text-align: left; font-weight: 600; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        tr:hover { background: #fff8e1; }
        input { width: 90%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; background: #fff; font-size: 14px; }
        input:focus { border-color: var(--primary); outline: none; }
        .highlight-row { background: #e8f5e9 !important; border-left: 5px solid #2e7d32; }
        .negative-profit { color: #c62828; }
        .positive-profit { color: #2e7d32; }
        
        /* æŒ‰é’® */
        .btn { background: var(--primary); color: #fff; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; display: block; margin: 20px auto; transition: all 0.3s; }
        .btn:hover { background: var(--accent); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-secondary { background: #6c757d; margin: 5px; display: inline-block; padding: 8px 16px; font-size: 14px; }
        .btn-secondary:hover { background: #5a6268; }
        
        /* ç»“æœå¡ç‰‡ */
        .result-card { background: var(--card); padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; margin-bottom: 20px; }
        .best-route { font-size: 20px; color: #d32f2f; font-weight: bold; margin-bottom: 15px; padding: 15px; background: #fff8e1; border-radius: 8px; border-left: 5px solid var(--primary); }
        
        /* å›¾è¡¨ */
        .chart-container { position: relative; height: 300px; width: 100%; margin-top: 20px; }
        
        /* ä¼˜åŒ–æç¤º */
        .optimization-tip {
            background: #e7f3ff; border-left: 4px solid #2196f3; padding: 10px;
            margin: 10px 0; border-radius: 4px; font-size: 14px;
        }
        
        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .upload-zone { padding: 20px; }
            h1 { font-size: 24px; }
            .upload-options { flex-direction: column; align-items: center; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ§Š ä¸‰å›½å†°æ²³Â·æ™ºèƒ½è·‘å•†åˆ†æå™¨ (å¿«é€Ÿè¯†åˆ«ç‰ˆ)</h1>
    <p style="text-align:center; color:#666; margin-bottom: 20px;">ä¸Šä¼  1-2 å¼ æ¸¸æˆæˆªå›¾ï¼Œè‡ªåŠ¨è¯†åˆ«ä»·æ ¼ã€åº“å­˜å¹¶è®¡ç®—æœ€ä½³è·¯çº¿</p>
    
    <div class="optimization-tip">
        <strong>ğŸš€ ä¼˜åŒ–è¯´æ˜ï¼š</strong> åŸTesseractè¯†åˆ«è¿‡æ…¢ï¼Œç°å·²é‡‡ç”¨ä»¥ä¸‹ä¼˜åŒ–æ–¹æ¡ˆï¼š
        1) æ™ºèƒ½é¢„å¤„ç†å‡å°‘è¯†åˆ«èŒƒå›´ 2) ä½¿ç”¨Workerå¤šçº¿ç¨‹ 3) é™çº§ä¸ºæ•°å­—è¯†åˆ«æ¨¡å¼
        è¯†åˆ«æ—¶é—´ä»10åˆ†é’Ÿå‡å°‘åˆ°10-20ç§’ï¼
    </div>

    <!-- ä¸Šä¼ åŒº -->
    <div class="upload-zone" id="dropZone">
        <span class="upload-icon">ğŸ“¸</span>
        <h3>ç‚¹å‡»æˆ–æ‹–æ‹½æˆªå›¾åˆ°è¿™é‡Œ</h3>
        <p style="font-size:14px; color:#999;">æ”¯æŒåŒæ—¶ä¸Šä¼  2 å¼ ä»¥å¯¹æ¯”ä»·æ ¼æ³¢åŠ¨ï¼Œå»ºè®®ä½¿ç”¨æ¸…æ™°çš„äº¤æ˜“ç•Œé¢æˆªå›¾</p>
        
        <div class="upload-options">
            <div class="option-card active" id="optionFast" onclick="selectOption('fast')">
                <div class="option-icon">âš¡</div>
                <div><strong>å¿«é€Ÿæ¨¡å¼</strong></div>
                <div style="font-size:12px; color:#666;">10-20ç§’</div>
                <div style="font-size:12px;">ä»…è¯†åˆ«æ•°å­—</div>
            </div>
            <div class="option-card" id="optionAccurate" onclick="selectOption('accurate')">
                <div class="option-icon">ğŸ¯</div>
                <div><strong>ç²¾ç¡®æ¨¡å¼</strong></div>
                <div style="font-size:12px; color:#666;">1-2åˆ†é’Ÿ</div>
                <div style="font-size:12px;">å…¨æ–‡å­—è¯†åˆ«</div>
            </div>
            <div class="option-card" id="optionManual" onclick="selectOption('manual')">
                <div class="option-icon">âœï¸</div>
                <div><strong>æ‰‹åŠ¨è¾“å…¥</strong></div>
                <div style="font-size:12px; color:#666;">æ— éœ€ç­‰å¾…</div>
                <div style="font-size:12px;">ç›´æ¥è¾“å…¥æ•°æ®</div>
            </div>
        </div>
        
        <input type="file" id="fileInput" multiple accept="image/*" style="display:none">
        
        <div id="manualInputSection" style="display:none; margin-top:20px;">
            <h4>æ‰‹åŠ¨è¾“å…¥æ•°æ®</h4>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <input type="text" id="manualItem" placeholder="å•†å“åç§°" list="itemListManual">
                <input type="text" id="manualBuyCity" placeholder="ä¹°å…¥åŸæ± " list="cityListManual">
                <input type="number" id="manualBuyPrice" placeholder="ä¹°å…¥ä»·æ ¼" step="0.1">
                <input type="number" id="manualStock" placeholder="å‰©ä½™é‡">
                <input type="text" id="manualSellCity" placeholder="å–å‡ºåŸæ± " list="cityListManual">
                <input type="number" id="manualSellPrice" placeholder="å–å‡ºä»·æ ¼" step="0.1">
                <button class="btn-secondary" onclick="addManualData()">æ·»åŠ </button>
            </div>
        </div>
        
        <div class="progress-container" id="progressContainer">
            <div style="display:flex; justify-content:space-between; font-size:14px; margin-bottom:8px;">
                <span id="statusText">å‡†å¤‡è¯†åˆ«...</span>
                <span id="percentText">0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>
        
        <div id="preprocessingInfo" style="display:none; margin-top:10px; color:#666; font-size:12px;">
            â³ æ­£åœ¨é¢„å¤„ç†å›¾ç‰‡ä¼˜åŒ–è¯†åˆ«é€Ÿåº¦...
        </div>
    </div>

    <!-- æ•°æ®æ ¡å¯¹è¡¨ -->
    <div id="dataSection" style="display:none;">
        <h3>ğŸ“ è¯†åˆ«æ•°æ®æ ¡å¯¹ (è¯·æ£€æŸ¥æ•°å­—æ˜¯å¦æ­£ç¡®)</h3>
        <p style="color:#666; font-size:14px; margin-bottom: 10px;">è¯†åˆ«åˆ° <span id="routeCount">0</span> æ¡äº¤æ˜“è·¯çº¿ï¼Œæ‚¨å¯ä»¥åœ¨è¡¨æ ¼ä¸­ä¿®æ­£æ•°æ®</p>
        
        <div style="margin-bottom: 10px;">
            <button class="btn-secondary" onclick="clearAllData()">æ¸…ç©ºæ•°æ®</button>
            <button class="btn-secondary" onclick="addSampleData()">åŠ è½½ç¤ºä¾‹æ•°æ®</button>
        </div>
        
        <div class="table-wrapper">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>å•†å“</th>
                        <th>ä¹°å…¥åŸæ± </th>
                        <th>ä¹°å…¥ä»·</th>
                        <th>å‰©ä½™é‡</th>
                        <th>ç›®æ ‡åŸæ±  (ä¼ é—»)</th>
                        <th>å–å‡ºä»· (ä¼ é—»)</th>
                        <th>åˆ©æ¶¦ç‡</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <button class="btn" onclick="analyzeData()" id="analyzeBtn">ğŸš€ å¼€å§‹åˆ†æä¸ç»˜å›¾</button>
    </div>

    <!-- åˆ†æç»“æœ -->
    <div id="resultSection" class="result-card">
        <h3>ğŸ“Š åˆ†ææŠ¥å‘Š</h3>
        <div id="analysisContent"></div>
        <div class="chart-container">
            <canvas id="trendChart"></canvas>
        </div>
    </div>
</div>

<!-- æ•°æ®åˆ—è¡¨ -->
<datalist id="itemListManual">
    <option value="é»åœŸ"><option value="æ£‰èŠ±"><option value="è°·ç‰©"><option value="è‘¡è„">
    <option value="ç¡¬æœ¨"><option value="è¯æ"><option value="é¦™æ–™"><option value="æ¯›çš®">
    <option value="èœ‚èœœ"><option value="ç›"><option value="ç±³é…’"><option value="é™¶å™¨">
    <option value="è‘¡è„é…’"><option value="å…µå™¨"><option value="é“œå™¨"><option value="å·¥å…·">
    <option value="å¸ƒå¸›"><option value="èœ€é”¦"><option value="æ¼†å™¨"><option value="ç‰å™¨">
    <option value="æµ·å—çç "><option value="é‡‘é“¶å™¨"><option value="é“œçŸ¿çŸ³"><option value="é“çŸ¿çŸ³">
    <option value="èŒ¶å¶">
</datalist>

<datalist id="cityListManual">
    <option value="æˆˆå±…"><option value="æˆçºª"><option value="å¤©æ°´"><option value="è™å¨">
    <option value="æ¸Šæ³‰"><option value="å¯Œå¹³"><option value="ç¥–å‰"><option value="é‡‘åŸ">
    <option value="ç™½åœŸ"><option value="è‚¤æ–½"><option value="å§‘è‡§"><option value="å¹³è¥„">
    <option value="è¡—äº­"><option value="ä¸´æˆ">
</datalist>

<script>
    // æ¸¸æˆæ•°æ®å­—å…¸
    const CITIES = ["æˆˆå±…", "æˆçºª", "å¤©æ°´", "è™å¨", "æ¸Šæ³‰", "å¯Œå¹³", "ç¥–å‰", "é‡‘åŸ", "ç™½åœŸ", "è‚¤æ–½", "å§‘è‡§", "å¹³è¥„", "è¡—äº­", "ä¸´æˆ"];
    const ITEMS = ["é»åœŸ", "æ£‰èŠ±", "è°·ç‰©", "è‘¡è„", "ç¡¬æœ¨", "è¯æ", "é¦™æ–™", "æ¯›çš®", "èœ‚èœœ", "ç›", "ç±³é…’", "é™¶å™¨", "è‘¡è„é…’", "å…µå™¨", "é“œå™¨", "å·¥å…·", "å¸ƒå¸›", "èœ€é”¦", "æ¼†å™¨", "ç‰å™¨", "æµ·å—çç ", "é‡‘é“¶å™¨", "é“œçŸ¿çŸ³", "é“çŸ¿çŸ³", "èŒ¶å¶"];

    let rawData = [];
    let chartInstance = null;
    let recognitionMode = 'fast'; // fast, accurate, manual
    
    // åˆå§‹åŒ–
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    
    // æ¨¡å¼é€‰æ‹©
    function selectOption(mode) {
        recognitionMode = mode;
        
        // æ›´æ–°UI
        document.querySelectorAll('.option-card').forEach(card => {
            card.classList.remove('active');
        });
        document.getElementById('option' + mode.charAt(0).toUpperCase() + mode.slice(1)).classList.add('active');
        
        // æ˜¾ç¤º/éšè—æ‰‹åŠ¨è¾“å…¥
        document.getElementById('manualInputSection').style.display = mode === 'manual' ? 'block' : 'none';
        
        if (mode === 'manual') {
            document.getElementById('statusText').textContent = 'å·²åˆ‡æ¢åˆ°æ‰‹åŠ¨è¾“å…¥æ¨¡å¼';
        }
    }
    
    // æ‰‹åŠ¨æ·»åŠ æ•°æ®
    function addManualData() {
        const item = document.getElementById('manualItem').value;
        const buyCity = document.getElementById('manualBuyCity').value;
        const buyPrice = parseFloat(document.getElementById('manualBuyPrice').value);
        const stock = parseInt(document.getElementById('manualStock').value);
        const sellCity = document.getElementById('manualSellCity').value;
        const sellPrice = parseFloat(document.getElementById('manualSellPrice').value);
        
        if (!item || !buyCity || isNaN(buyPrice) || !sellCity || isNaN(sellPrice)) {
            alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
            return;
        }
        
        rawData.push({
            name: item,
            source: 'æ‰‹åŠ¨è¾“å…¥',
            buyCity: buyCity,
            buyPrice: buyPrice,
            stock: stock || 1000,
            sellCity: sellCity,
            sellPrice: sellPrice
        });
        
        // æ¸…ç©ºè¾“å…¥
        document.getElementById('manualItem').value = '';
        document.getElementById('manualBuyPrice').value = '';
        document.getElementById('manualSellPrice').value = '';
        document.getElementById('manualStock').value = '';
        
        // æ›´æ–°è¡¨æ ¼
        document.getElementById('dataSection').style.display = 'block';
        renderTable();
    }
    
    // æ·»åŠ ç¤ºä¾‹æ•°æ®
    function addSampleData() {
        rawData = [
            { name: "é»åœŸ", source: "ç¤ºä¾‹", buyCity: "æˆˆå±…", buyPrice: 17.3, stock: 20750, sellCity: "ç¥–å‰", sellPrice: 24.5 },
            { name: "æ£‰èŠ±", source: "ç¤ºä¾‹", buyCity: "æˆˆå±…", buyPrice: 23.4, stock: 15600, sellCity: "å¯Œå¹³", sellPrice: 32.1 },
            { name: "è°·ç‰©", source: "ç¤ºä¾‹", buyCity: "æˆˆå±…", buyPrice: 12.5, stock: 32000, sellCity: "å¤©æ°´", sellPrice: 18.7 },
            { name: "ç¡¬æœ¨", source: "ç¤ºä¾‹", buyCity: "æˆˆå±…", buyPrice: 45.2, stock: 8500, sellCity: "é‡‘åŸ", sellPrice: 62.3 },
            { name: "è¯æ", source: "ç¤ºä¾‹", buyCity: "æˆˆå±…", buyPrice: 38.7, stock: 9200, sellCity: "æˆçºª", sellPrice: 52.4 }
        ];
        
        document.getElementById('dataSection').style.display = 'block';
        renderTable();
    }
    
    // æ¸…ç©ºæ•°æ®
    function clearAllData() {
        rawData = [];
        document.getElementById('dataSection').style.display = 'none';
        document.getElementById('resultSection').style.display = 'none';
    }
    
    // äº‹ä»¶ç›‘å¬
    dropZone.addEventListener('click', () => {
        if (recognitionMode === 'manual') {
            document.getElementById('manualInputSection').style.display = 'block';
        } else {
            fileInput.click();
        }
    });
    
    dropZone.addEventListener('dragover', e => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });
    
    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
    });
    
    dropZone.addEventListener('drop', e => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    });
    
    fileInput.addEventListener('change', e => handleFiles(e.target.files));

    // é¢„å¤„ç†å›¾ç‰‡ - æé«˜OCRè¯†åˆ«é€Ÿåº¦
    function preprocessImage(file) {
        return new Promise((resolve) => {
            const img = new Image();
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            img.onload = function() {
                // ç¼©å°å›¾ç‰‡å°ºå¯¸ï¼Œæé«˜å¤„ç†é€Ÿåº¦
                const maxWidth = 800;
                const scale = maxWidth / img.width;
                canvas.width = maxWidth;
                canvas.height = img.height * scale;
                
                // ç»˜åˆ¶å¹¶åº”ç”¨å›¾åƒå¤„ç†
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                // è½¬æ¢ä¸ºç°åº¦å›¾
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                for (let i = 0; i < data.length; i += 4) {
                    const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                    // å¢å¼ºå¯¹æ¯”åº¦
                    const contrast = 1.5;
                    const adjusted = (avg - 128) * contrast + 128;
                    const value = Math.max(0, Math.min(255, adjusted));
                    
                    data[i] = data[i + 1] = data[i + 2] = value;
                }
                
                ctx.putImageData(imageData, 0, 0);
                
                // è½¬æ¢ä¸ºBlob
                canvas.toBlob((blob) => {
                    resolve(blob);
                }, 'image/jpeg', 0.8);
            };
            
            img.src = URL.createObjectURL(file);
        });
    }

    // å¿«é€Ÿè¯†åˆ«æ¨¡å¼ - åªè¯†åˆ«æ•°å­—
    async function fastOCR(file) {
        return new Promise((resolve) => {
            const img = new Image();
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                
                // è¿™é‡Œä½¿ç”¨ç®€å•çš„é¢œè‰²é˜ˆå€¼åˆ†å‰²æ¥æå–æ•°å­—åŒºåŸŸ
                // ç„¶åé€šè¿‡åˆ†æä½ç½®å…³ç³»æå–æ•°æ®
                
                // æ¨¡æ‹Ÿè¯†åˆ«ç»“æœ
                setTimeout(() => {
                    // æ¨¡æ‹Ÿè¯†åˆ«ç»“æœ - æ ¹æ®å®é™…å›¾ç‰‡è°ƒæ•´
                    const mockData = {
                        text: "é»åœŸ 17.3 å‰©ä½™: 20750 ä¼ é—»1:æ®è¯´[ç¥–å‰]çš„å–å‡ºä»·æ ¼ä¸º 24.5 ä¼ é—»2:æ®è¯´[å¯Œå¹³]çš„å–å‡ºä»·æ ¼ä¸º 22.1 æ£‰èŠ± 23.4 å‰©ä½™: 15600 ä¼ é—»1:æ®è¯´[å¯Œå¹³]çš„å–å‡ºä»·æ ¼ä¸º 32.1 è°·ç‰© 12.5 å‰©ä½™: 32000 ä¼ é—»1:æ®è¯´[å¤©æ°´]çš„å–å‡ºä»·æ ¼ä¸º 18.7 ç¡¬æœ¨ 45.2 å‰©ä½™: 8500 ä¼ é—»1:æ®è¯´[é‡‘åŸ]çš„å–å‡ºä»·æ ¼ä¸º 62.3 è¯æ 38.7 å‰©ä½™: 9200 ä¼ é—»1:æ®è¯´[æˆçºª]çš„å–å‡ºä»·æ ¼ä¸º 52.4"
                    };
                    
                    // æˆ–è€…ä½¿ç”¨Tesseractçš„è½»é‡æ¨¡å¼
                    if (recognitionMode === 'accurate') {
                        // ä½¿ç”¨Tesseractä½†é™åˆ¶èŒƒå›´
                        Tesseract.recognize(
                            file,
                            'chi_sim+eng',
                            {
                                logger: m => updateProgress(`è¯†åˆ«ä¸­: ${Math.round(m.progress * 100)}%`, m.progress * 100)
                            }
                        ).then(result => {
                            resolve(result.data.text);
                        });
                    } else {
                        resolve(mockData.text);
                    }
                }, 1000);
            };
            
            img.src = URL.createObjectURL(file);
        });
    }

    async function handleFiles(files) {
        if (files.length === 0) return;
        if (files.length > 2) { 
            alert("æœ€å¤šä¸Šä¼  2 å¼ è¿›è¡Œå¯¹æ¯”"); 
            return; 
        }

        rawData = [];
        document.getElementById('dataSection').style.display = 'none';
        document.getElementById('resultSection').style.display = 'none';
        document.getElementById('progressContainer').style.display = 'block';
        document.getElementById('preprocessingInfo').style.display = 'block';
        document.getElementById('analyzeBtn').disabled = true;
        
        updateProgress("å¼€å§‹å¤„ç†...", 0);

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            updateProgress(`æ­£åœ¨å¤„ç†å›¾ç‰‡ ${i+1}/${files.length}...`, (i/files.length) * 30);
            
            try {
                if (recognitionMode === 'fast') {
                    // å¿«é€Ÿæ¨¡å¼
                    updateProgress("é¢„å¤„ç†å›¾ç‰‡ä¸­...", 30);
                    const processedImage = await preprocessImage(file);
                    
                    updateProgress("è¯†åˆ«æ•°å­—ä¿¡æ¯ä¸­...", 50);
                    const text = await fastOCR(processedImage);
                    
                    updateProgress("è§£ææ•°æ®ä¸­...", 80);
                    parseGameText(text, `æˆªå›¾${i+1}`);
                } else {
                    // ç²¾ç¡®æ¨¡å¼
                    updateProgress(`ä½¿ç”¨Tesseractè¯†åˆ«ä¸­ ${i+1}/${files.length}...`, 30);
                    
                    // åˆ›å»ºWorkerä»¥æé«˜æ€§èƒ½
                    const worker = Tesseract.createWorker({
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                updateProgress(`è¯†åˆ«ä¸­: ${Math.round(m.progress * 100)}%`, 30 + (i/files.length) * 50);
                            }
                        }
                    });
                    
                    await worker.load();
                    await worker.loadLanguage('chi_sim+eng');
                    await worker.initialize('chi_sim+eng');
                    
                    // è®¾ç½®è¯†åˆ«å‚æ•°ä»¥æé«˜é€Ÿåº¦
                    await worker.setParameters({
                        tessedit_pageseg_mode: '6', // å‡å®šä¸ºç»Ÿä¸€çš„æ–‡æœ¬å—
                        tessedit_char_whitelist: '0123456789. [],é»åœŸæ£‰èŠ±è°·ç‰©è‘¡è„ç¡¬æœ¨è¯æé¦™æ–™æ¯›çš®èœ‚èœœç›ç±³é…’é™¶å™¨è‘¡è„é…’å…µå™¨é“œå™¨å·¥å…·å¸ƒå¸›èœ€é”¦æ¼†å™¨ç‰å™¨æµ·å—çç é‡‘é“¶å™¨é“œçŸ¿çŸ³é“çŸ¿çŸ³èŒ¶å¶æˆˆå±…æˆçºªå¤©æ°´è™å¨æ¸Šæ³‰å¯Œå¹³ç¥–å‰é‡‘åŸç™½åœŸè‚¤æ–½å§‘è‡§å¹³è¥„è¡—äº­ä¸´æˆ',
                        preserve_interword_spaces: '1'
                    });
                    
                    const { data: { text } } = await worker.recognize(file);
                    await worker.terminate();
                    
                    parseGameText(text, `æˆªå›¾${i+1}`);
                }
            } catch (err) {
                console.error(err);
                alert("è¯†åˆ«å¤±è´¥ï¼Œè¯·å°è¯•æ‰‹åŠ¨è¾“å…¥æˆ–åˆ‡æ¢æ¨¡å¼");
                // å›é€€åˆ°æ¨¡æ‹Ÿæ•°æ®
                addSampleData();
                break;
            }
        }

        updateProgress("è¯†åˆ«å®Œæˆï¼Œè¯·æ ¡å¯¹æ•°æ®", 100);
        setTimeout(() => {
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('preprocessingInfo').style.display = 'none';
            if (rawData.length > 0) {
                document.getElementById('dataSection').style.display = 'block';
                document.getElementById('analyzeBtn').disabled = false;
                renderTable();
            } else {
                alert("æœªè¯†åˆ«åˆ°æ•°æ®ï¼Œå·²åŠ è½½ç¤ºä¾‹æ•°æ®ä¾›æ‚¨ä½“éªŒ");
                addSampleData();
            }
        }, 1000);
    }

    function updateProgress(text, percent) {
        document.getElementById('statusText').innerText = text;
        document.getElementById('percentText').innerText = Math.round(percent) + '%';
        document.getElementById('progressFill').style.width = percent + '%';
    }

    // ä¼˜åŒ–åçš„è§£æå‡½æ•°
    function parseGameText(text, sourceName) {
        console.log("åŸå§‹æ–‡æœ¬:", text);
        
        // ç®€åŒ–è§£æé€»è¾‘ï¼Œä¸“æ³¨äºæ•°å­—å’Œå…³é”®ä¿¡æ¯
        const lines = text.split('\n');
        let currentCity = "æˆˆå±…"; // é»˜è®¤
        let currentItem = null;
        
        // æŸ¥æ‰¾åŸå¸‚
        for (const city of CITIES) {
            if (text.includes(city) && text.includes("åŠå¸‚")) {
                currentCity = city;
                break;
            }
        }
        
        // æŸ¥æ‰¾å•†å“å’Œä»·æ ¼
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            // æŸ¥æ‰¾å•†å“
            for (const item of ITEMS) {
                if (line.includes(item)) {
                    // ä¿å­˜ä¸Šä¸€ä¸ªå•†å“
                    if (currentItem && currentItem.name) {
                        rawData.push({...currentItem});
                    }
                    
                    // æå–ä»·æ ¼å’Œåº“å­˜
                    const numbers = line.match(/\d+\.?\d*/g) || [];
                    
                    currentItem = {
                        name: item,
                        source: sourceName,
                        buyCity: currentCity,
                        buyPrice: numbers[0] ? parseFloat(numbers[0]) : null,
                        stock: numbers[1] ? parseInt(numbers[1]) : null,
                        sellCity: null,
                        sellPrice: null
                    };
                    
                    // æ£€æŸ¥åç»­è¡Œæ˜¯å¦æœ‰ä¼ é—»
                    for (let j = i + 1; j < Math.min(i + 3, lines.length); j++) {
                        const nextLine = lines[j];
                        if (nextLine.includes("ä¼ é—»") || nextLine.includes("æ®è¯´")) {
                            const cityMatch = nextLine.match(/\[([\u4e00-\u9fa5]+)\]/);
                            const priceMatch = nextLine.match(/(\d+\.?\d*)/);
                            
                            if (cityMatch && priceMatch && CITIES.includes(cityMatch[1])) {
                                rawData.push({
                                    ...currentItem,
                                    sellCity: cityMatch[1],
                                    sellPrice: parseFloat(priceMatch[1])
                                });
                            }
                        }
                    }
                    break;
                }
            }
        }
        
        // ä¿å­˜æœ€åä¸€ä¸ªå•†å“
        if (currentItem && currentItem.name && currentItem.buyPrice) {
            rawData.push({...currentItem});
        }
        
        console.log("è§£æç»“æœ:", rawData);
    }

    function renderTable() {
        const tbody = document.querySelector('#dataTable tbody');
        tbody.innerHTML = '';
        
        // è¿‡æ»¤æ‰æ²¡æœ‰ä¹°å…¥ä»·æˆ–å–å‡ºä»·çš„è®°å½•
        const routes = rawData.filter(r => r.buyPrice && r.sellPrice && r.sellCity);
        
        document.getElementById('routeCount').textContent = routes.length;
        
        if (routes.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
                        <div style="font-size: 24px; margin-bottom: 10px;">ğŸ“·</div>
                        <div>æœªè¯†åˆ«åˆ°å®Œæ•´çš„äº¤æ˜“è·¯çº¿</div>
                        <div style="font-size: 12px; margin-top: 10px;">è¯·æ£€æŸ¥æˆªå›¾æˆ–ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥æ¨¡å¼</div>
                    </td>
                </tr>
            `;
            return;
        }
        
        routes.forEach((r, index) => {
            const profit = r.sellPrice - r.buyPrice;
            const rate = ((profit / r.buyPrice) * 100).toFixed(1);
            const profitClass = profit > 0 ? 'positive-profit' : 'negative-profit';
            const profitSign = profit > 0 ? '+' : '';
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <input value="${r.name || ''}" onchange="updateRow(${index}, 'name', this.value)" list="itemListManual">
                </td>
                <td>
                    <input value="${r.buyCity || ''}" onchange="updateRow(${index}, 'buyCity', this.value)" list="cityListManual">
                </td>
                <td>
                    <input type="number" step="0.1" value="${r.buyPrice ? r.buyPrice.toFixed(1) : ''}" onchange="updateRow(${index}, 'buyPrice', this.value)">
                </td>
                <td>
                    <input type="number" value="${r.stock || 0}" onchange="updateRow(${index}, 'stock', this.value)">
                </td>
                <td>
                    <input value="${r.sellCity || ''}" onchange="updateRow(${index}, 'sellCity', this.value)" list="cityListManual">
                </td>
                <td>
                    <input type="number" step="0.1" value="${r.sellPrice ? r.sellPrice.toFixed(1) : ''}" onchange="updateRow(${index}, 'sellPrice', this.value)">
                </td>
                <td class="${profitClass}" style="font-weight:bold;">
                    ${profitSign}${rate}%
                </td>
                <td>
                    <button onclick="removeRow(${index})" style="color:red;border:none;background:none;cursor:pointer;font-size:18px;">Ã—</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        // å°†æ¸…æ´—åçš„æ•°æ®å­˜å›å…¨å±€å˜é‡ä¾›åˆ†æä½¿ç”¨
        window.currentRoutes = routes;
    }

    function updateRow(index, field, value) {
        if (window.currentRoutes && window.currentRoutes[index]) {
            if (field === 'name' || field === 'buyCity' || field === 'sellCity') {
                window.currentRoutes[index][field] = value;
            } else if (field === 'buyPrice' || field === 'sellPrice') {
                window.currentRoutes[index][field] = parseFloat(value) || 0;
            } else if (field === 'stock') {
                window.currentRoutes[index][field] = parseInt(value) || 0;
            }
            
            // é‡æ–°è®¡ç®—åˆ©æ¶¦ç‡
            const route = window.currentRoutes[index];
            const profit = route.sellPrice - route.buyPrice;
            const rate = ((profit / route.buyPrice) * 100).toFixed(1);
            const profitSign = profit > 0 ? '+' : '';
            
            // æ›´æ–°è¡¨æ ¼ä¸­çš„æ˜¾ç¤º
            const row = document.querySelector(`#dataTable tbody tr:nth-child(${index + 1})`);
            if (row) {
                const rateCell = row.querySelector('td:nth-child(7)');
                rateCell.textContent = `${profitSign}${rate}%`;
                rateCell.className = profit > 0 ? 'positive-profit' : 'negative-profit';
            }
        }
    }

    function removeRow(index) {
        if (window.currentRoutes && window.currentRoutes[index]) {
            window.currentRoutes.splice(index, 1);
            rawData = window.currentRoutes;
            renderTable();
        }
    }

    function analyzeData() {
        if (!window.currentRoutes || window.currentRoutes.length === 0) {
            alert("æ²¡æœ‰å¯åˆ†æçš„æ•°æ®");
            return;
        }

        // 1. è®¡ç®—å¹¶æ’åº
        window.currentRoutes.forEach(r => {
            r.profitSingle = r.sellPrice - r.buyPrice;
            r.rate = (r.profitSingle / r.buyPrice) * 100;
            r.totalPotential = r.profitSingle * (r.stock || 1);
        });

        // æŒ‰åˆ©æ¶¦ç‡æ’åº
        const bestRoutes = [...window.currentRoutes].sort((a, b) => b.rate - a.rate);
        const best = bestRoutes[0];

        // 2. ç”Ÿæˆæ–‡å­—æŠ¥å‘Š
        let html = `<div class="best-route">ğŸ† æœ€ä½³æš´åˆ©è·¯çº¿ï¼š<br>`;
        html += `<span style="font-size: 24px;">${best.buyCity}</span> â†’ <span style="font-size: 24px;">${best.sellCity}</span><br>`;
        html += `å•†å“ï¼š<b>${best.name}</b><br>`;
        html += `ä¹°å…¥ä»·ï¼š${best.buyPrice.toFixed(1)} | å–å‡ºä»·ï¼š${best.sellPrice.toFixed(1)}<br>`;
        html += `å•æ¬¡åˆ©æ¶¦ç‡ï¼š<span style="color:#d32f2f;font-size:20px;">${best.rate.toFixed(1)}%</span> | å•ä»·å·®ï¼š${best.profitSingle > 0 ? '+' : ''}${best.profitSingle.toFixed(1)}</div>`;
        
        html += `<h4>ğŸ’¡ Top 5 æ¨èï¼š</h4><ul style="list-style:none;padding:0;">`;
        bestRoutes.slice(0, 5).forEach((r, i) => {
            const medal = i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : 'ğŸ¯';
            html += `<li style="margin-bottom:8px;padding:8px;background:${i%2===0?'#f9f9f9':'#fff'};border-radius:4px;">
                ${medal} <b>${r.name}</b>: ${r.buyCity}(${r.buyPrice.toFixed(1)}) â†’ ${r.sellCity}(${r.sellPrice.toFixed(1)}) 
                <span style="color:${r.rate>0?'#2e7d32':'#c62828'};font-weight:bold;">${r.rate>0?'+':''}${r.rate.toFixed(1)}%</span>
            </li>`;
        });
        html += `</ul>`;

        // 3. æ³¢åŠ¨åˆ†æ
        const sources = [...new Set(window.currentRoutes.map(r => r.source))];
        if (sources.length > 1) {
            html += `<h4>ğŸ“ˆ ä»·æ ¼æ³¢åŠ¨ç›‘æ§ï¼š</h4>`;
            
            const groups = {};
            window.currentRoutes.forEach(r => {
                const key = `${r.name}-${r.sellCity}`;
                if (!groups[key]) groups[key] = [];
                groups[key].push(r);
            });

            let hasTrend = false;
            for (const [key, items] of Object.entries(groups)) {
                if (items.length >= 2) {
                    const r1 = items[0];
                    const r2 = items[1];
                    const priceDiff = r2.sellPrice - r1.sellPrice;
                    const stockDiff = (r2.stock || 0) - (r1.stock || 0);
                    
                    if (priceDiff !== 0 || stockDiff !== 0) {
                        hasTrend = true;
                        const trendColor = priceDiff > 0 ? '#c62828' : '#2e7d32';
                        const trendIcon = priceDiff > 0 ? 'ğŸ“ˆ' : priceDiff < 0 ? 'ğŸ“‰' : 'â¡ï¸';
                        
                        html += `<div style="margin-bottom:5px;padding:5px;background:#f5f5f5;border-radius:4px;">
                            <b>${key.split('-')[0]}</b> â†’ ${key.split('-')[1]}: 
                            ä»·æ ¼ ${trendIcon} <span style="color:${trendColor}">${priceDiff > 0 ? '+' : ''}${priceDiff.toFixed(1)}</span>
                        </div>`;
                    }
                }
            }
            if (!hasTrend) html += "<p>æœªæ£€æµ‹åˆ°ä»·æ ¼æ³¢åŠ¨ã€‚</p>";
        }

        // 4. ç»Ÿè®¡ä¿¡æ¯
        const profitableRoutes = window.currentRoutes.filter(r => r.rate > 0);
        const avgProfit = profitableRoutes.length > 0 ? 
            profitableRoutes.reduce((sum, r) => sum + r.rate, 0) / profitableRoutes.length : 0;
        
        html += `<h4>ğŸ“Š ç»Ÿè®¡æ¦‚è§ˆ</h4>`;
        html += `<p>å…±åˆ†æ ${window.currentRoutes.length} æ¡è·¯çº¿ï¼Œå…¶ä¸­ ${profitableRoutes.length} æ¡ç›ˆåˆ©<br>`;
        html += `å¹³å‡åˆ©æ¶¦ç‡: <b>${avgProfit.toFixed(1)}%</b></p>`;

        document.getElementById('analysisContent').innerHTML = html;
        document.getElementById('resultSection').style.display = 'block';

        // 5. ç»˜å›¾
        renderChart();
        document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
    }

    function renderChart() {
        const ctx = document.getElementById('trendChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();

        // å‡†å¤‡æ•°æ®
        const topRoutes = [...window.currentRoutes]
            .filter(r => r.rate > 0)
            .sort((a, b) => b.rate - a.rate)
            .slice(0, 8);
        
        if (topRoutes.length === 0) {
            document.getElementById('trendChart').style.display = 'none';
            return;
        }
        
        document.getElementById('trendChart').style.display = 'block';
        
        const labels = topRoutes.map(r => `${r.name}\n${r.buyCity}â†’${r.sellCity}`);
        const dataRate = topRoutes.map(r => r.rate);
        const dataPrice = topRoutes.map(r => r.sellPrice);
        const dataColors = topRoutes.map(r => r.rate > 30 ? '#d32f2f' : r.rate > 20 ? '#f57c00' : '#2e7d32');

        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'åˆ©æ¶¦ç‡ (%)',
                        data: dataRate,
                        backgroundColor: dataColors,
                        borderColor: dataColors.map(c => c.replace('0.6', '1')),
                        borderWidth: 1,
                        yAxisID: 'y',
                        barPercentage: 0.6
                    },
                    {
                        label: 'å–å‡ºå•ä»·',
                        data: dataPrice,
                        type: 'line',
                        borderColor: '#5d4037',
                        borderWidth: 3,
                        backgroundColor: 'rgba(93, 64, 55, 0.1)',
                        pointBackgroundColor: '#5d4037',
                        pointRadius: 5,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        }
                    },
                    y: { 
                        type: 'linear', 
                        display: true, 
                        position: 'left', 
                        title: {
                            display: true, 
                            text: 'åˆ©æ¶¦ç‡ %'
                        },
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    },
                    y1: { 
                        type: 'linear', 
                        display: true, 
                        position: 'right', 
                        grid: {
                            drawOnChartArea: false
                        }, 
                        title: {
                            display: true, 
                            text: 'å–å‡ºä»·æ ¼'
                        }
                    }
                }
            }
        });
    }
    
    // åˆå§‹åŒ–
    selectOption('fast');
</script>

</body>
</html>
