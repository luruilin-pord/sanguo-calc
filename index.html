<body>
    <div class="container">
        <h1>ğŸ§Š ä¸‰å›½å†°æ²³Â·æç®€è·‘å•†è®¡ç®—å™¨</h1>
        <div class="note">ğŸ’¡ æç¤ºï¼šè¾“å…¥æ‹¼éŸ³é¦–å­—æ¯å¿«é€Ÿæœç´¢ (å¦‚ "tks"=é“œçŸ¿çŸ³)ã€‚ä¿®æ”¹åå½“å‰è¡Œåˆ©æ¶¦/åˆ©æ¶¦ç‡æ ‡è“ã€‚</div>
        
        <div class="table-wrapper">
            <table id="tradingTable">
                <thead>
                    <tr>
                        <th style="width: 18%;">å•†å“</th>
                        <th style="width: 12%;">ä¹°å…¥ä»·</th>
                        <th style="width: 12%;">å–å‡ºä»·</th>
                        <th style="width: 12%;">æ•°é‡</th>
                        <th style="width: 12%;">æ€»æˆæœ¬</th>
                        <th style="width: 12%;">åˆ©æ¶¦ç‡</th>
                        <th style="width: 14%;">å‡€åˆ©æ¶¦</th>
                        <th style="width: 8%;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- ç§»é™¤äº† .summary-bar -->

        <button class="btn-add" onclick="addRow()">+ æ·»åŠ ä¸€è¡Œ</button>
        <div class="footer">æ•°æ®ä»…ä¾›è§„åˆ’å‚è€ƒï¼Œå®é™…äº¤æ˜“è¯·ä»¥æ¸¸æˆå†…ä¸ºå‡†</div>
    </div>

    <script>
        // å•†å“æ•°æ®åº“ï¼ˆä¸å˜ï¼‰
        const products = [
            {n:"é»åœŸ",w:15,p:"nian tu"}, {n:"æ£‰èŠ±",w:13,p:"mian hua"}, {n:"èŒ¶å¶",w:13,p:"cha ye"},
            {n:"é“çŸ¿çŸ³",w:34,p:"tie kuang shi"}, {n:"é“œçŸ¿çŸ³",w:35,p:"tong kuang shi"}, {n:"è°·ç‰©",w:10,p:"gu wu"},
            {n:"è‘¡è„",w:10,p:"pu tao"}, {n:"ç¡¬æœ¨",w:15,p:"ying mu"}, {n:"è¯æ",w:11,p:"yao cai"},
            {n:"é¦™æ–™",w:10,p:"xiang liao"}, {n:"æ¯›çš®",w:18,p:"mao pi"}, {n:"èœ‚èœœ",w:29,p:"feng mi"},
            {n:"ç›",w:35,p:"yan"}, {n:"ç±³é…’",w:30,p:"mi jiu"}, {n:"é™¶å™¨",w:30,p:"tao qi"},
            {n:"è‘¡è„é…’",w:30,p:"pu tao jiu"}, {n:"å…µå™¨",w:52,p:"bing qi"}, {n:"é“œå™¨",w:55,p:"tong qi"},
            {n:"å·¥å…·",w:50,p:"gong ju"}, {n:"å¸ƒå¸›",w:16,p:"bu bo"}, {n:"èœ€é”¦",w:10,p:"shu jin"},
            {n:"æ¼†å™¨",w:32,p:"qi qi"}, {n:"ç‰å™¨",w:32,p:"yu qi"}, {n:"æµ·å—çç ",w:12,p:"hai nan zhen zhu"},
            {n:"é‡‘é“¶å™¨",w:27,p:"jin yin qi"}
        ];

        window.onload = () => {
            addRow("è°·ç‰©", 14.1, 17.6, 100); 
            addRow("èŒ¶å¶", 58.4, 73.1, 50);
        };

        function addRow(defName="", buy="", sell="", qty="") {
            const tbody = document.querySelector('#tradingTable tbody');
            const tr = document.createElement('tr');
            
            tr.innerHTML = `
                <td>
                    <div class="custom-select-wrapper" data-def="${defName}">
                        <input type="text" class="custom-select-input" placeholder="æœå•†å“..." autocomplete="off">
                        <div class="custom-options"></div>
                    </div>
                </td>
                <td><input type="number" class="buy-price" value="${buy}" step="0.1" placeholder="0"></td>
                <td><input type="number" class="sell-price" value="${sell}" step="0.1" placeholder="0"></td>
                <td><input type="number" class="plan-qty" value="${qty}" step="1" placeholder="0"></td>
                <td><input type="text" class="cost-display" readonly value="0"></td>
                <td><div class="rate-cell">-</div></td>
                <td><div class="profit-cell">0.00</div></td>
                <td><button class="btn-del" onclick="removeRow(this)">Ã—</button></td>
            `;
            tbody.appendChild(tr);
            
            initSelect(tr.querySelector('.custom-select-wrapper'));
            
            if(defName) setTimeout(()=>{
                const inp = tr.querySelector('.custom-select-input');
                inp.value = defName;
                selectOpt(tr.querySelector('.custom-select-wrapper'), defName, true);
            }, 0);
            
            // ç»‘å®šè¾“å…¥äº‹ä»¶ â€”â€” å…³é”®ï¼šæ·»åŠ  modified æ ‡è®°
            tr.querySelectorAll('input').forEach(i => {
                i.addEventListener('input', () => {
                    // æ ‡è®°è¯¥è¡Œä¸ºå·²ä¿®æ”¹
                    tr.dataset.modified = 'true';
                    calcRow(tr);
                });
            });
            
            calcRow(tr);
        }

        function removeRow(btn) {
            const rows = document.querySelectorAll('#tradingTable tbody tr');
            if (rows.length > 1) {
                btn.closest('tr').remove();
            } else {
                const row = btn.closest('tr');
                row.querySelectorAll('input').forEach(i => {
                    if(!i.readOnly) i.value = '';
                    if(i.classList.contains('custom-select-input')) i.value = '';
                });
                delete row.dataset.modified; // æ¸…é™¤æ ‡è®°
                calcRow(row);
            }
        }

        function initSelect(wrap) {
            const inp = wrap.querySelector('.custom-select-input');
            const optsDiv = wrap.querySelector('.custom-options');
            const row = wrap.closest('tr');
            
            products.forEach(prod => {
                const d = document.createElement('div');
                d.className = 'custom-option';
                d.innerHTML = `<span>${prod.n}</span><span class="weight-tag">${prod.w}</span>`;
                d.dataset.v = prod.n;
                d.dataset.p = prod.p;
                optsDiv.appendChild(d);
            });
            
            const noRes = document.createElement('div'); 
            noRes.className='no-results'; 
            noRes.textContent='æ— åŒ¹é…å•†å“'; 
            optsDiv.appendChild(noRes);

            inp.addEventListener('focus', e => { 
                e.stopPropagation(); 
                closeAll(); 
                wrap.classList.add('open'); 
                filter(inp.value, optsDiv, noRes); 
            });
            inp.addEventListener('input', e => { 
                e.stopPropagation(); 
                wrap.classList.add('open'); 
                filter(inp.value, optsDiv, noRes); 
                // æ ‡è®°ä¸ºå·²ä¿®æ”¹
                row.dataset.modified = 'true';
            });
            
            optsDiv.addEventListener('mousedown', e => {
                e.preventDefault();
                const t = e.target.classList.contains('custom-option') ? e.target : e.target.parentElement;
                if(t.classList.contains('custom-option')) {
                    selectOpt(wrap, t.dataset.v, true);
                    row.dataset.modified = 'true'; // é€‰æ‹©å•†å“ä¹Ÿç®—ä¿®æ”¹
                    calcRow(row);
                }
            });
            
            document.addEventListener('click', e => { 
                if(!wrap.contains(e.target)) wrap.classList.remove('open'); 
            });
        }

        function filter(q, container, noRes) {
            const qs = q.toLowerCase().trim();
            let has = false;
            container.querySelectorAll('.custom-option').forEach(opt => {
                const n = opt.dataset.v, p = opt.dataset.p;
                const match = n.includes(qs) || p.replace(/\s/g,'').includes(qs) || p.split(' ').map(x=>x[0]).join('').includes(qs);
                opt.style.display = match ? 'flex' : 'none';
                if(match) has = true;
            });
            noRes.style.display = has ? 'none' : 'block';
        }

        function selectOpt(wrap, val, force) {
            const inp = wrap.querySelector('.custom-select-input');
            inp.value = val; 
            wrap.classList.remove('open');
            wrap.querySelectorAll('.custom-option').forEach(o => {
                o.classList.toggle('selected', o.dataset.v === val);
            });
        }

        function closeAll() { 
            document.querySelectorAll('.custom-select-wrapper').forEach(w => w.classList.remove('open')); 
        }

        function calcRow(row) {
            const buy = parseFloat(row.querySelector('.buy-price').value) || 0;
            const sell = parseFloat(row.querySelector('.sell-price').value) || 0;
            const qty = parseInt(row.querySelector('.plan-qty').value) || 0;
            
            const cost = buy * qty;
            const profit = (sell - buy) * qty;
            const rate = cost > 0 ? (profit / cost) * 100 : 0;
            
            row.querySelector('.cost-display').value = cost.toLocaleString('zh-CN', {maximumFractionDigits: 1});
            
            const profitCell = row.querySelector('.profit-cell');
            profitCell.textContent = profit.toLocaleString('zh-CN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            const rateCell = row.querySelector('.rate-cell');
            rateCell.textContent = rate.toFixed(1) + '%';
            
            // ===== æ ¸å¿ƒé€»è¾‘ï¼šåˆ¤æ–­æ˜¯å¦æ ‡è“ =====
            if (row.dataset.modified === 'true') {
                // å·²ä¿®æ”¹ï¼šå¼ºåˆ¶è“è‰²
                profitCell.style.color = '#1976d2';
                rateCell.style.color = '#1976d2';
                profitCell.className = 'profit-cell';
                rateCell.className = 'rate-cell';
            } else {
                // æœªä¿®æ”¹ï¼šæ¢å¤åŸé€»è¾‘
                profitCell.style.color = '';
                rateCell.style.color = '';
                profitCell.className = 'profit-cell ' + (profit >= 0 ? '' : 'loss');
                rateCell.className = 'rate-cell ' + (rate >= 20 ? 'rate-high' : (rate < 0 ? 'loss' : 'rate-low'));
            }
        }
    </script>
</body>
