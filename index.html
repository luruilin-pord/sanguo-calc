<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‰å›½å†°æ²³æ—¶ä»£ - ç»ˆæè·‘å•†è®¡ç®—å™¨</title>
    <style>
        :root {
            --primary-color: #2575fc;
            --bg-color: #f5f5f5;
            --text-color: #333;
            --border-color: #ddd;
            --success-color: #2e7d32;
            --danger-color: #d32f2f;
        }
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            color: var(--text-color);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: visible; /* å…è®¸ä¸‹æ‹‰æ¡†æº¢å‡ºæ˜¾ç¤º */
        }
        h1 {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            margin: 0;
            font-size: 24px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }
        th, td {
            padding: 12px 15px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
            font-size: 14px;
        }
        th {
            background-color: #f8f9fa;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 20; /* æé«˜å±‚çº§ */
            white-space: nowrap;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        tr:nth-child(even) { background-color: #fafafa; }
        tr:hover { background-color: #f1f7ff; }
        
        /* è¾“å…¥æ¡†é€šç”¨æ ·å¼ */
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
            transition: all 0.3s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(37, 117, 252, 0.2);
            z-index: 5;
            position: relative;
        }

        /* è‡ªå®šä¹‰ä¸‹æ‹‰é€‰æ‹©å™¨æ ¸å¿ƒæ ·å¼ */
        .custom-select-wrapper {
            position: relative;
            user-select: none;
            width: 100%;
            z-index: 30; /* ç¡®ä¿é«˜äºè¡¨æ ¼å…¶ä»–éƒ¨åˆ† */
        }
        .custom-select-input {
            cursor: text; /* æ”¹ä¸ºæ–‡æœ¬å…‰æ ‡ï¼Œæç¤ºå¯è¾“å…¥ */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23999' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 30px;
            background-color: #fff;
        }
        .custom-options {
            position: absolute;
            display: block;
            top: 100%;
            left: 0;
            right: 0;
            border: 1px solid var(--primary-color);
            border-top: 0;
            background: #fff;
            transition: all 0.2s;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            z-index: 1000; /* æé«˜ä¼˜å…ˆçº§ï¼Œé˜²æ­¢è¢«é®æŒ¡ */
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            border-radius: 0 0 4px 4px;
            margin-top: -1px; /* æ— ç¼è¿æ¥ */
        }
        .custom-select-wrapper.open .custom-options {
            opacity: 1;
            visibility: visible;
            pointer-events: all;
        }
        .custom-option {
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
        }
        .custom-option:hover {
            background-color: #eef2ff;
            color: var(--primary-color);
        }
        .custom-option.selected {
            background-color: #e0e7ff;
            font-weight: bold;
        }
        .custom-option span.weight-tag {
            font-size: 12px;
            color: #888;
            background: #eee;
            padding: 2px 6px;
            border-radius: 4px;
        }
        .no-results {
            padding: 15px;
            color: #999;
            text-align: center;
            font-style: italic;
            display: none;
        }

        .profit-cell {
            font-weight: bold;
            font-size: 15px;
        }
        .footer {
            text-align: center;
            padding: 15px;
            font-size: 13px;
            color: #666;
            background-color: #f8f9fa;
            border-top: 1px solid #eee;
        }
        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 5px;
            background-color: #e3f2fd;
            color: #1976d2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ä¸‰å›½å†°æ²³æ—¶ä»£ - ç»ˆæè·‘å•†è®¡ç®—å™¨ <span class="badge">è‡ªåŠ¨è´Ÿé‡ + å…¨ç¨ç‡</span></h1>
        <table id="tradingTable">
            <thead>
                <tr>
                    <th style="width: 18%;">å•†å“åç§°<br><span style="font-size:12px;font-weight:normal;color:#666">æ”¯æŒæ‹¼éŸ³/ä¸­æ–‡/é¦–å­—æ¯</span></th>
                    <th style="width: 10%;">ä¹°å…¥ä»·</th>
                    <th style="width: 10%;">å–å‡ºä»·</th>
                    <th style="width: 10%;">å·²å ç”¨è´Ÿé‡</th>
                    <th style="width: 10%;">é©¬è½¦æ€»è´Ÿé‡</th>
                    <th style="width: 10%;">å•ä»¶è´Ÿé‡<br><span style="font-size:12px;font-weight:normal;color:#666">è‡ªåŠ¨å¡«å……</span></th>
                    <th style="width: 12%;">ç¨ç‡<br><span style="font-size:12px;font-weight:normal;color:#666">10%-90%</span></th>
                    <th style="width: 12%;">é¢„è®¡åˆ©æ¶¦</th>
                    <th style="width: 8%;"><button onclick="addRow()" style="background:#2575fc;color:white;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;">+ æ·»åŠ </button></th>
                </tr>
            </thead>
            <tbody>
                <!-- è¡Œå°†ç”±JSåŠ¨æ€ç”Ÿæˆï¼Œä¿è¯åˆå§‹çŠ¶æ€ä¸€è‡´ -->
            </tbody>
        </table>
        <div class="footer">
            ğŸ’¡ <strong>ä½¿ç”¨æŠ€å·§ï¼š</strong> ç‚¹å‡»å•†å“æ¡†ç›´æ¥è¾“å…¥æ‹¼éŸ³ (å¦‚ "tks" = é“œçŸ¿çŸ³) æˆ–ä¸­æ–‡ã€‚é€‰æ‹©åè´Ÿé‡è‡ªåŠ¨å¡«å…¥ã€‚ç¨ç‡æ”¯æŒ10%-90%ä»»æ„æ¡£ä½ã€‚
        </div>
    </div>

    <script>
        // å®Œæ•´çš„25ç§ææ–™æ•°æ®åº“
        const productData = [
            { name: "é»åœŸ", weight: 15, py: "nian tu" },
            { name: "æ£‰èŠ±", weight: 13, py: "mian hua" },
            { name: "èŒ¶å¶", weight: 13, py: "cha ye" },
            { name: "é“çŸ¿çŸ³", weight: 34, py: "tie kuang shi" },
            { name: "é“œçŸ¿çŸ³", weight: 35, py: "tong kuang shi" },
            { name: "è°·ç‰©", weight: 10, py: "gu wu" },
            { name: "è‘¡è„", weight: 10, py: "pu tao" },
            { name: "ç¡¬æœ¨", weight: 15, py: "ying mu" },
            { name: "è¯æ", weight: 11, py: "yao cai" },
            { name: "é¦™æ–™", weight: 10, py: "xiang liao" },
            { name: "æ¯›çš®", weight: 18, py: "mao pi" },
            { name: "èœ‚èœœ", weight: 29, py: "feng mi" },
            { name: "ç›", weight: 35, py: "yan" },
            { name: "ç±³é…’", weight: 30, py: "mi jiu" },
            { name: "é™¶å™¨", weight: 30, py: "tao qi" },
            { name: "è‘¡è„é…’", weight: 30, py: "pu tao jiu" },
            { name: "å…µå™¨", weight: 52, py: "bing qi" },
            { name: "é“œå™¨", weight: 55, py: "tong qi" },
            { name: "å·¥å…·", weight: 50, py: "gong ju" },
            { name: "å¸ƒå¸›", weight: 16, py: "bu bo" },
            { name: "èœ€é”¦", weight: 10, py: "shu jin" },
            { name: "æ¼†å™¨", weight: 32, py: "qi qi" },
            { name: "ç‰å™¨", weight: 32, py: "yu qi" },
            { name: "æµ·å—çç ", weight: 12, py: "hai nan zhen zhu" },
            { name: "é‡‘é“¶å™¨", weight: 27, py: "jin yin qi" }
        ];

        // åˆå§‹åŒ–é¡µé¢
        window.onload = function() {
            addRow("é“œçŸ¿çŸ³", 34.9, 42.5, 500, 6000, 0.2);
            addRow("é»åœŸ", 16.8, 23.4, 500, 6000, 0.1);
            addRow("è‘¡è„", 12.1, 16.8, 900, 7000, 0.2);
        };

        function addRow(defaultProduct = "", buy = "", sell = "", used = "", max = "", tax = "") {
            const tbody = document.querySelector('#tradingTable tbody');
            const tr = document.createElement('tr');
            
            // ç”Ÿæˆç¨ç‡é€‰é¡¹ (0%, 10% - 90%)
            let taxOptions = `<option value="0">0%</option>`;
            for (let i = 10; i <= 90; i++) {
                taxOptions += `<option value="${i/100}" ${i/100 == tax ? 'selected' : ''}>${i}%</option>`;
            }

            tr.innerHTML = `
                <td>
                    <div class="custom-select-wrapper" data-default="${defaultProduct}">
                        <input type="text" class="custom-select-input" placeholder="è¾“å…¥æ‹¼éŸ³æˆ–ä¸­æ–‡..." autocomplete="off">
                        <div class="custom-options"></div>
                    </div>
                </td>
                <td><input type="number" class="buy-price" value="${buy}" step="0.1"></td>
                <td><input type="number" class="sell-price" value="${sell}" step="0.1"></td>
                <td><input type="number" class="used-weight" value="${used}"></td>
                <td><input type="number" class="max-weight" value="${max}"></td>
                <td><input type="number" class="item-weight" value="" readonly style="background-color:#f0f0f0;"></td>
                <td>
                    <select class="tax-rate">
                        ${taxOptions}
                    </select>
                </td>
                <td class="profit-cell">0.00</td>
                <td><button onclick="removeRow(this)" style="background:#ff5252;color:white;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;">Ã—</button></td>
            `;
            
            tbody.appendChild(tr);
            
            // åˆå§‹åŒ–è¯¥è¡Œçš„ä¸‹æ‹‰é€»è¾‘
            const wrapper = tr.querySelector('.custom-select-wrapper');
            initCustomSelect(wrapper);
            
            // å¦‚æœæœ‰é»˜è®¤å€¼ï¼Œé€‰ä¸­å®ƒ
            if (defaultProduct) {
                // ç¨å¾®å»¶è¿Ÿä»¥ç¡®ä¿DOMå°±ç»ª
                setTimeout(() => {
                    const input = wrapper.querySelector('.custom-select-input');
                    input.value = defaultProduct;
                    selectOption(wrapper, defaultProduct, true);
                }, 0);
            }

            // ç»‘å®šè¯¥è¡Œå…¶ä»–è¾“å…¥äº‹ä»¶
            tr.querySelectorAll('input, select').forEach(input => {
                input.addEventListener('input', () => calculateProfit(tr));
            });
        }

        function removeRow(btn) {
            const rows = document.querySelectorAll('#tradingTable tbody tr');
            if (rows.length > 1) {
                btn.closest('tr').remove();
            } else {
                alert("è‡³å°‘ä¿ç•™ä¸€è¡Œæ•°æ®ï¼");
            }
        }

        function initCustomSelect(wrapper) {
            const input = wrapper.querySelector('.custom-select-input');
            const optionsContainer = wrapper.querySelector('.custom-options');
            const row = wrapper.closest('tr');
            const weightInput = row.querySelector('.item-weight');
            
            // ç”Ÿæˆé€‰é¡¹åˆ—è¡¨
            productData.forEach(prod => {
                const div = document.createElement('div');
                div.className = 'custom-option';
                div.innerHTML = `<span>${prod.name}</span> <span class="weight-tag">${prod.weight}</span>`;
                div.dataset.value = prod.name;
                div.dataset.weight = prod.weight;
                div.dataset.py = prod.py;
                optionsContainer.appendChild(div);
            });

            const noResults = document.createElement('div');
            noResults.className = 'no-results';
            noResults.textContent = 'æœªæ‰¾åˆ°åŒ¹é…å•†å“';
            optionsContainer.appendChild(noResults);

            // 1. èšç„¦æ—¶æ‰“å¼€ä¸‹æ‹‰æ¡†
            input.addEventListener('focus', (e) => {
                e.stopPropagation();
                closeAllSelects();
                wrapper.classList.add('open');
                filterOptions(input.value, optionsContainer, noResults);
            });

            // 2. è¾“å…¥æ—¶è¿‡æ»¤
            input.addEventListener('input', (e) => {
                e.stopPropagation(); // é˜»æ­¢å†’æ³¡
                wrapper.classList.add('open');
                filterOptions(input.value, optionsContainer, noResults);
            });

            // 3. ç‚¹å‡»é€‰é¡¹
            optionsContainer.addEventListener('mousedown', (e) => { // ä½¿ç”¨ mousedown é˜²æ­¢ blur å…ˆè§¦å‘
                e.preventDefault(); // é˜²æ­¢è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹
                if (e.target.classList.contains('custom-option') || e.target.parentElement.classList.contains('custom-option')) {
                    const target = e.target.classList.contains('custom-option') ? e.target : e.target.parentElement;
                    selectOption(wrapper, target.dataset.value, true);
                }
            });

            // 4. ç‚¹å‡»å¤–éƒ¨å…³é—­
            document.addEventListener('click', (e) => {
                if (!wrapper.contains(e.target)) {
                    wrapper.classList.remove('open');
                }
            });
            
            // 5. å…è®¸æ‰‹åŠ¨ä¿®æ”¹è´Ÿé‡ï¼ˆåŒå‡»æˆ–èšç„¦ï¼‰
            weightInput.addEventListener('focus', function() {
                this.style.backgroundColor = '#fff';
                this.style.borderColor = '#ffa000';
            });
            weightInput.addEventListener('blur', function() {
                if(!this.value) this.style.backgroundColor = '#f0f0f0';
            });
        }

        function filterOptions(query, container, noResultsMsg) {
            const options = container.querySelectorAll('.custom-option');
            let hasResult = false;
            const q = query.toLowerCase().trim();
            
            options.forEach(opt => {
                const name = opt.dataset.value;
                const py = opt.dataset.py;
                
                // åŒ¹é…é€»è¾‘ï¼šä¸­æ–‡åŒ…å« æˆ– æ‹¼éŸ³å…¨æ‹¼åŒ…å« æˆ– æ‹¼éŸ³é¦–å­—æ¯åŒ¹é…
                const matchName = name.includes(q);
                
                // æ‹¼éŸ³å¤„ç†ï¼šæ”¯æŒ "tongkuangshi" æˆ– "tks"
                const pyNoSpace = py.replace(/\s/g, '');
                const pyFirstChars = py.split(' ').map(w => w[0]).join('');
                
                const matchPyFull = pyNoSpace.includes(q);
                const matchPyFirst = pyFirstChars.includes(q);

                if (matchName || matchPyFull || matchPyFirst) {
                    opt.style.display = 'flex';
                    hasResult = true;
                } else {
                    opt.style.display = 'none';
                }
            });

            noResultsMsg.style.display = hasResult ? 'none' : 'block';
        }

        function selectOption(wrapper, value, forceUpdateWeight) {
            const input = wrapper.querySelector('.custom-select-input');
            const options = wrapper.querySelectorAll('.custom-option');
            const row = wrapper.closest('tr');
            const weightInput = row.querySelector('.item-weight');
            
            const product = productData.find(p => p.name === value);
            
            input.value = value;
            wrapper.classList.remove('open');
            
            options.forEach(opt => {
                if (opt.dataset.value === value) {
                    opt.classList.add('selected');
                } else {
                    opt.classList.remove('selected');
                }
            });

            if (product && forceUpdateWeight) {
                weightInput.value = product.weight;
                // è§†è§‰åé¦ˆ
                weightInput.style.backgroundColor = '#e8f5e9';
                setTimeout(() => {
                    if (document.activeElement !== weightInput) {
                        weightInput.style.backgroundColor = '#f0f0f0';
                    }
                }, 500);
            }

            calculateProfit(row);
        }

        function closeAllSelects() {
            document.querySelectorAll('.custom-select-wrapper').forEach(w => {
                if (w !== event.currentTarget) w.classList.remove('open');
            });
        }

        function calculateProfit(row) {
            const buyPrice = parseFloat(row.querySelector('.buy-price').value) || 0;
            const sellPrice = parseFloat(row.querySelector('.sell-price').value) || 0;
            const usedWeight = parseFloat(row.querySelector('.used-weight').value) || 0;
            const maxWeight = parseFloat(row.querySelector('.max-weight').value) || 0;
            let itemWeight = parseFloat(row.querySelector('.item-weight').value);
            const taxRate = parseFloat(row.querySelector('.tax-rate').value) || 0;
            
            // å¦‚æœè´Ÿé‡ä¸ºç©ºï¼Œæš‚æ—¶æŒ‰1è®¡ç®—é¿å…é™¤ä»¥0é”™è¯¯ï¼Œä½†åˆ©æ¶¦ä¼šä¸å‡†ï¼Œæç¤ºç”¨æˆ·é€‰æ‹©å•†å“
            if (!itemWeight) itemWeight = 1;

            const availableWeight = Math.max(0, maxWeight - usedWeight);
            const quantity = availableWeight / itemWeight;
            const profit = (sellPrice - buyPrice) * quantity * (1 - taxRate);
            
            const profitCell = row.querySelector('.profit-cell');
            profitCell.textContent = profit.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            
            if (profit < 0) {
                profitCell.style.color = 'var(--danger-color)';
            } else if (profit === 0) {
                profitCell.style.color = '#666';
            } else {
                profitCell.style.color = 'var(--success-color)';
            }
        }
    </script>
</body>
</html>
