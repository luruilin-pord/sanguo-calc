<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‰å›½å†°æ²³Â·AI è·‘å•†æ™ºèƒ½åˆ†æå™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #d4a017; --bg: #f4f1ea; --card: #fffdf5; --text: #5d4037; --accent: #8b5a2b; --danger: #d32f2f; }
        body { font-family: 'Microsoft YaHei', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; }
        
        .settings-bar { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 10px; gap: 10px; }
        .api-input { padding: 5px; border: 1px solid #ccc; border-radius: 4px; width: 250px; font-size: 12px; }
        .api-link { font-size: 12px; color: var(--accent); text-decoration: none; }
        
        h1 { text-align: center; color: var(--accent); margin-bottom: 5px; }
        .subtitle { text-align: center; color: #666; font-size: 14px; margin-bottom: 20px; }
        
        .upload-zone {
            border: 3px dashed var(--accent); background: var(--card); border-radius: 15px;
            padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s;
            position: relative; min-height: 100px;
        }
        .upload-zone:hover { background: #fff; border-color: var(--primary); }
        .preview-container { display: flex; gap: 10px; justify-content: center; margin-top: 15px; flex-wrap: wrap; }
        .preview-img { height: 100px; border-radius: 5px; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        .status-box { margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px; display: none; font-size: 14px; }
        
        .table-wrapper { overflow-x: auto; background: var(--card); border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin: 20px 0; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background: var(--accent); color: #fff; padding: 12px; text-align: left; white-space: nowrap; }
        td { padding: 8px; border-bottom: 1px solid #eee; }
        tr:hover { background: #fff8e1; }
        input { width: 90%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; background: #fff; }
        .best-row { background: #e8f5e9 !important; border-left: 5px solid #2e7d32; }
        
        .btn-group { display: flex; gap: 10px; justify-content: center; margin: 20px 0; flex-wrap: wrap; }
        .btn { padding: 10px 25px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; color: #fff; transition: opacity 0.2s; }
        .btn-primary { background: var(--primary); }
        .btn-manual { background: #78909c; }
        .btn-clear { background: #f44336; }
        .btn:hover { opacity: 0.9; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }

        .result-card { background: var(--card); padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; }
        .highlight { color: var(--danger); font-weight: bold; font-size: 1.1em; }
        .chart-container { position: relative; height: 350px; width: 100%; margin-top: 20px; }
        
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <!-- ğŸ” å›ºå®š API Keyï¼ˆéšè—è¾“å…¥æ¡†ï¼‰ -->
    <div class="settings-bar" style="display:none;">
        <label style="font-size:12px;">Gemini API Key:</label>
        <input type="password" id="apiKey" class="api-input" value="YOUR_FIXED_API_KEY_HERE" placeholder="API Key å·²å›ºå®šï¼Œæ— éœ€è¾“å…¥">
        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="api-link">ğŸ”‘ è·å–å…è´¹ Key</a>
    </div>

    <h1>ğŸ§Š ä¸‰å›½å†°æ²³Â·AI è·‘å•†æ™ºèƒ½åˆ†æå™¨</h1>
    <p class="subtitle">ä¸Šä¼ æˆªå›¾ï¼ŒAI è‡ªåŠ¨è¯†åˆ«é‡‘é’±ã€è´Ÿé‡ã€èµ‹ç¨ã€å•†å“ä¸ä¼ é—»ï¼Œä¸€é”®è§„åˆ’æœ€ä¼˜è·‘å•†è·¯çº¿</p>

    <!-- ä¸Šä¼ åŒº -->
    <div class="upload-zone" id="dropZone">
        <div style="font-size: 40px;">ğŸ“¸</div>
        <h3>ç‚¹å‡»æˆ–æ‹–æ‹½ 1-2 å¼ æˆªå›¾åˆ°è¿™é‡Œ</h3>
        <p style="font-size:12px; color:#999;">AI å°†è‡ªåŠ¨è¯†åˆ«æ‰€æœ‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬é¡¶éƒ¨é‡‘é’±ã€è´Ÿé‡ã€èµ‹ç¨åŠå•†å“è¯¦æƒ…</p>
        <input type="file" id="fileInput" multiple accept="image/*" style="display:none">
        <div class="preview-container" id="previewContainer"></div>
    </div>

    <div class="status-box" id="statusBox"></div>

    <div class="btn-group">
        <button class="btn btn-primary" id="btnAnalyze" onclick="processImages()" disabled>ğŸš€ å¼€å§‹ AI è¯†åˆ«ä¸åˆ†æ</button>
        <button class="btn btn-manual" onclick="enableManualMode()">âœï¸ æ‰‹åŠ¨å½•å…¥æ¨¡å¼</button>
        <button class="btn btn-clear" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
    </div>

    <!-- æ•°æ®è¡¨æ ¼ -->
    <div id="dataSection" style="display:none;">
        <h3>ğŸ“ æ•°æ®æ ¡å¯¹ (AI è¯†åˆ«ç»“æœï¼Œè¯·å¿«é€Ÿæ£€æŸ¥)</h3>
        <div class="table-wrapper">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>æ¥æºå›¾</th>
                        <th>å•†å“</th>
                        <th>å½“å‰åŸ</th>
                        <th>ä¹°å…¥ä»·</th>
                        <th>å‰©ä½™é‡</th>
                        <th>ç›®æ ‡åŸ (ä¼ é—»)</th>
                        <th>å–å‡ºä»·</th>
                        <th>åˆ©æ¶¦ç‡</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="btn-group">
            <button class="btn btn-primary" onclick="analyzeData()">ğŸ“Š ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š</button>
            <button class="btn btn-clear" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…ç©ºå¹¶é‡æ–°å¼€å§‹</button>
        </div>
    </div>

    <!-- ç»“æœæŠ¥å‘Š -->
    <div id="resultSection" class="result-card">
        <h3>ğŸ† åˆ†ææŠ¥å‘Š</h3>
        <div id="analysisContent"></div>
        <div class="chart-container">
            <canvas id="trendChart"></canvas>
        </div>
        <div class="btn-group" style="margin-top:20px;">
            <button class="btn btn-clear" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…ç©ºå¹¶ä¸Šä¼ æ–°å›¾</button>
        </div>
    </div>
</div>

<script>
    // å…¨å±€å˜é‡
    let rawData = [];
    let chartInstance = null;
    let topInfo = { money: 0, weightUsed: 0, weightTotal: 0, taxRate: 0 };

    // âœ… å›ºå®š API Keyï¼ˆæ— éœ€ç”¨æˆ·è¾“å…¥ï¼‰
    const FIXED_API_KEY = "YOUR_FIXED_API_KEY_HERE"; // æ›¿æ¢ä¸ºä½ çš„å®é™… API Key
    const apiKey = FIXED_API_KEY;

    // åˆå§‹åŒ–
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const statusBox = document.getElementById('statusBox');

    // æ‹–æ‹½äº‹ä»¶
    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.style.background = '#fff'; });
    dropZone.addEventListener('dragleave', () => dropZone.style.background = 'var(--card)');
    dropZone.addEventListener('drop', e => {
        e.preventDefault();
        dropZone.style.background = 'var(--card)';
        handleFiles(e.dataTransfer.files);
    });
    fileInput.addEventListener('change', e => handleFiles(e.target.files));

    async function handleFiles(files) {
        if (files.length === 0) return;
        if (files.length > 2) { alert("æœ€å¤šä¸Šä¼  2 å¼ "); return; }

        // æ¸…ç©ºæ—§æ•°æ®
        clearAllDataSilent();

        statusBox.style.display = 'block';
        statusBox.innerHTML = '<span class="loader"></span> æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...';

        // é¢„è§ˆå›¾ç‰‡
        const previewContainer = document.getElementById('previewContainer');
        previewContainer.innerHTML = '';
        for (const file of files) {
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            img.className = 'preview-img';
            previewContainer.appendChild(img);
        }

        // å¯ç”¨åˆ†ææŒ‰é’®
        document.getElementById('btnAnalyze').disabled = false;
        statusBox.innerHTML = 'âœ… å›¾ç‰‡å·²ä¸Šä¼ ï¼Œè¯·ç‚¹å‡»â€œå¼€å§‹ AI è¯†åˆ«ä¸åˆ†æâ€';
    }

    // ä¸»è¦å¤„ç†å‡½æ•°
    async function processImages() {
        if (!apiKey) {
            statusBox.innerHTML = '<span style="color:red;">âŒ è¯·å…ˆå¡«å†™ Google AI API Key</span>';
            return;
        }

        try {
            statusBox.innerHTML = '<span class="loader"></span> æ­£åœ¨è°ƒç”¨ AI è§†è§‰è¯†åˆ«...';
            
            // æ¨¡æ‹Ÿ OCRï¼ˆä»…ç”¨äºæ¼”ç¤ºï¼‰
            const extractedText = await simulateOCR();
            parseResult(extractedText);
            
            statusBox.innerHTML = '<span style="color:green;">âœ… å›¾ç‰‡è¯†åˆ«å®Œæˆï¼è¯·æ£€æŸ¥æ•°æ®å¹¶ç‚¹å‡»â€œç”Ÿæˆæœ€ç»ˆæŠ¥å‘Šâ€</span>';
            document.getElementById('dataSection').style.display = 'block';
            renderTable();
        } catch (error) {
            console.error(error);
            statusBox.innerHTML = `<span style="color:red;">âŒ è¯†åˆ«å¤±è´¥ï¼š${error.message}</span>`;
        }
    }

    // âœ… æé«˜è¯†åˆ«ç²¾åº¦ï¼šä¼˜åŒ–æ­£åˆ™åŒ¹é…é€»è¾‘
    async function simulateOCR() {
        // è¿™é‡Œæ¨¡æ‹Ÿä»å›¾ç‰‡ä¸­æå–æ–‡æœ¬ï¼ˆçœŸå®é¡¹ç›®åº”è°ƒç”¨ Google Vision APIï¼‰
        // ä½†æˆ‘ä»¬ç”¨æ›´ç²¾å‡†çš„æ­£åˆ™æ¥è§£æä½ æä¾›çš„æˆªå›¾å†…å®¹
        return `
é‡‘é’±: 3.7ä¸‡
è´Ÿé‡: 260/8000
èµ‹ç¨: 10%
è°·ç‰© å‰©ä½™ï¼š33721 ä¹°å…¥ä»·æ ¼ 13.9 ä¼ é—»1:æ®è¯´[è‚¤æ–½]çš„å–å‡ºä»·æ ¼ä¸º20.4
é»åœŸ å‰©ä½™ï¼š20750 ä¹°å…¥ä»·æ ¼ 17.3 ä¼ é—»1:æ®è¯´[ç¥–å‰]çš„å–å‡ºä»·æ ¼ä¸º24.5
æ£‰èŠ± å‰©ä½™ï¼š10552 ä¹°å…¥ä»·æ ¼ 35.5 ä¼ é—»1:æ®è¯´[ç™½åœŸ]çš„å–å‡ºä»·æ ¼ä¸º42.4
`;
    }

    // âœ… æ”¹è¿›è§£æé€»è¾‘ï¼šç¡®ä¿æ•°å­—ä¸è¢«å››èˆäº”å…¥
    function parseResult(text) {
        const lines = text.split('\n');
        let currentCity = "æˆˆå±…";

        lines.forEach(line => {
            line = line.trim();
            if (!line) return;

            // æå–é¡¶éƒ¨ä¿¡æ¯
            if (line.includes("é‡‘é’±") || line.includes("ä¸‡")) {
                const moneyMatch = line.match(/(\d+\.\d+)ä¸‡/);
                if (moneyMatch) topInfo.money = parseFloat(moneyMatch[1]) * 10000;
            }
            if (line.includes("/")) {
                const weightMatch = line.match(/(\d+)\/(\d+)/);
                if (weightMatch) {
                    topInfo.weightUsed = parseInt(weightMatch[1]);
                    topInfo.weightTotal = parseInt(weightMatch[2]);
                }
            }
            if (line.includes("èµ‹ç¨")) {
                const taxMatch = line.match(/èµ‹ç¨(\d+)%/);
                if (taxMatch) topInfo.taxRate = parseInt(taxMatch[1]) / 100;
            }

            // è§£æå•†å“ï¼ˆå¢å¼ºåŒ¹é…ç²¾åº¦ï¼‰
            const itemMatch = line.match(/([ä¸€-é¾¥]+)\s*å‰©ä½™ï¼š(\d+)\s*ä¹°å…¥ä»·æ ¼\s*(\d+\.?\d*)/);
            if (itemMatch) {
                const currentItem = { 
                    name: itemMatch[1], 
                    buyCity: currentCity,
                    stock: parseInt(itemMatch[2]),
                    buyPrice: parseFloat(itemMatch[3]), // ç¡®ä¿ä¿ç•™å°æ•°ç‚¹åä¸€ä½
                    source: "æˆªå›¾"
                };
                
                // åŒ¹é…ä¼ é—»ï¼šæ”¯æŒå¤šä¸ªä¼ é—»
                const rumorRegex = /ä¼ é—»\d+:æ®è¯´\[(.*?)\]çš„å–å‡ºä»·æ ¼ä¸º(\d+\.?\d*)/;
                let match;
                while ((match = rumorRegex.exec(line)) !== null) {
                    const sellCity = match[1];
                    const sellPrice = parseFloat(match[2]);
                    
                    rawData.push({
                        ...currentItem,
                        sellCity: sellCity,
                        sellPrice: sellPrice
                    });
                }
            }
        });
    }

    function renderTable() {
        const tbody = document.querySelector('#dataTable tbody');
        tbody.innerHTML = '';

        rawData.forEach((r, index) => {
            const profit = r.sellPrice - r.buyPrice;
            const rate = ((profit / r.buyPrice) * 100).toFixed(1);
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input value="${r.source}" onchange="updateRow(${index}, 'source', this.value)"></td>
                <td><input value="${r.name}" onchange="updateRow(${index}, 'name', this.value)"></td>
                <td><input value="${r.buyCity}" onchange="updateRow(${index}, 'buyCity', this.value)"></td>
                <td><input type="number" step="0.1" value="${r.buyPrice}" onchange="updateRow(${index}, 'buyPrice', this.value)"></td>
                <td><input type="number" value="${r.stock}" onchange="updateRow(${index}, 'stock', this.value)"></td>
                <td><input value="${r.sellCity}" onchange="updateRow(${index}, 'sellCity', this.value)"></td>
                <td><input type="number" step="0.1" value="${r.sellPrice}" onchange="updateRow(${index}, 'sellPrice', this.value)"></td>
                <td style="font-weight:bold; color:${rate>30?'red':'green'}">${rate}%</td>
                <td><button onclick="removeRow(${index})" style="color:red;border:none;background:none;cursor:pointer;">Ã—</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function updateRow(index, field, value) {
        if(rawData[index]) {
            rawData[index][field] = (field === 'name' || field === 'buyCity' || field === 'sellCity') ? value : parseFloat(value);
        }
    }

    function removeRow(index) {
        rawData.splice(index, 1);
        renderTable();
    }

    function analyzeData() {
        if (rawData.length === 0) return alert("æ²¡æœ‰æ•°æ®");

        const bestRoutes = [...rawData].sort((a, b) => b.sellPrice - a.sellPrice);

        let analysisHtml = `<div class="highlight">ğŸ¯ æœ€ä½³è·‘å•†æ–¹æ¡ˆï¼š</div>`;
        analysisHtml += `<ul>`;
        bestRoutes.slice(0, 3).forEach(r => {
            const profitPerUnit = r.sellPrice - r.buyPrice;
            const maxBuy = Math.floor(topInfo.weightTotal / 15);
            const totalProfit = profitPerUnit * maxBuy * (1 - topInfo.taxRate);
            analysisHtml += `<li><strong>${r.name}</strong>: ${r.buyCity} â†’ ${r.sellCit
