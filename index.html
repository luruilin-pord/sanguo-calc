<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸‰å›½å†°æ²³Â·æç®€è·‘å•†è®¡ç®—å™¨</title>
    <style>
        :root {
            --primary: #2575fc;
            --bg: #f5f5f5;
            --text: #333;
            --success: #2e7d32;
            --danger: #d32f2f;
            --warn: #f57c00;
            --blue: #1976d2;
            --orange: #f57c00;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 10px;
            color: var(--text);
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        h1 {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            color: #fff;
            margin: 0;
            font-size: 18px;
            letter-spacing: 1px;
        }
        
        /* è¡¨æ ¼æ ·å¼ */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            width: 100%;
        }
        table {
            width: 100%;
            border-collapse: separate; /* å…³é”®ï¼šå…è®¸ td æœ‰ spacing */
            border-spacing: 0 8px; /* å‚ç›´é—´è· 8px */
            min-width: 600px;
            table-layout: fixed;
        }
        colgroup {
            col:nth-child(1) { width: 15%; }
            col:nth-child(2) { width: 12%; }
            col:nth-child(3) { width: 12%; }
            col:nth-child(4) { width: 12%; }
            col:nth-child(5) { width: 12%; }
            col:nth-child(6) { width: 12%; }
            col:nth-child(7) { width: 14%; }
            col:nth-child(8) { width: 8%; }
        }
        th, td {
            padding: 14px 10px; /* åŠ å¤§å‚ç›´é—´è· */
            text-align: center;
            border: none;
            font-size: 13px;
            white-space: nowrap;
            box-sizing: border-box;
            background: #fff;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
            position: sticky;
            top: 0;
            z-index: 10;
            line-height: 1.4;
            border-bottom: 2px solid #ddd;
        }

        /* è¾“å…¥æ¡†æ ·å¼ */
        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 14px;
            text-align: center;
            transition: all 0.2s;
        }
        input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(37,117,252,0.15);
            background: #fff;
        }
        input[readonly] {
            background: #f9f9f9;
            color: #666;
            cursor: not-allowed;
            border-color: #eee;
        }

        /* ä¸‹æ‹‰æœç´¢ç»„ä»¶ â€”â€” ä¿®å¤æ˜¾ç¤ºé—®é¢˜ */
        .custom-select-wrapper {
            width: 100%;
            position: relative;
            display: inline-block;
        }
        .custom-select-input {
            cursor: text;
            background: #fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 12 12'%3E%3Cpath fill='%23999' d='M6 8L1 3h10z'/%3E%3C/svg%3E") no-repeat right 10px center;
            padding-right: 25px;
            text-align: left;
            width: 100%;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 6px;
        }
        .custom-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid var(--primary);
            border-top: 0;
            max-height: 250px;
            overflow-y: auto;
            z-index: 10000; /* æ›´é«˜ */
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
            border-radius: 0 0 6px 6px;
            display: none;
            margin-top: -1px;
        }
        .custom-select-wrapper.open .custom-options { display: block; }
        .custom-option {
            padding: 8px 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: left;
        }
        .custom-option:hover {
            background: #eef2ff;
            color: var(--primary);
        }
        .weight-tag {
            font-size: 11px;
            background: #eee;
            padding: 2px 6px;
            border-radius: 4px;
            color: #666;
        }
        .no-results {
            padding: 10px;
            text-align: center;
            color: #999;
            font-style: italic;
            display: none;
        }

        /* æ•°æ®å•å…ƒæ ¼æ ·å¼ */
        .profit-cell, .rate-cell {
            font-weight: bold;
            font-size: 14px;
            /* é»˜è®¤é»‘è‰²ï¼Œç”± JS æ§åˆ¶é¢œè‰² */
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn-add {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin: 15px auto;
            display: block;
            box-shadow: 0 4px 6px rgba(37,117,252,0.2);
            transition: transform 0.1s;
        }
        .btn-add:active { transform: scale(0.98); }
        .btn-del {
            background: #ffebee;
            color: var(--danger);
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background 0.2s;
        }
        .btn-del:hover { background: #ffcdd2; }

        .footer {
            text-align: center;
            padding: 15px;
            font-size: 12px;
            color: #888;
            background: #fafafa;
            border-top: 1px solid #eee;
        }
        .note {
            background: #e3f2fd;
            color: #1565c0;
            padding: 10px;
            font-size: 12px;
            text-align: center;
            border-bottom: 1px solid #bbdefb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§Š ä¸‰å›½å†°æ²³Â·æç®€è·‘å•†è®¡ç®—å™¨</h1>
        <div class="note">ğŸ’¡ æç¤ºï¼šè¾“å…¥æ‹¼éŸ³é¦–å­—æ¯å¿«é€Ÿæœç´¢ (å¦‚ "tks"=é“œçŸ¿çŸ³)ã€‚æ¯æ¬¡ä¿®æ”¹è¡Œä¼šæŒ‰é¡ºåºå˜è‰²ï¼šé»‘â†’ç»¿â†’çº¢â†’è“â†’æ©™â†’å¾ªç¯ã€‚</div>
        
        <div class="table-wrapper">
            <table id="tradingTable">
                <colgroup>
                    <col><col><col><col><col><col><col><col>
                </colgroup>
                <thead>
                    <tr>
                        <th>å•†å“</th>
                        <th>ä¹°å…¥ä»·</th>
                        <th>å–å‡ºä»·</th>
                        <th>æ•°é‡</th>
                        <th>æ€»æˆæœ¬</th>
                        <th>åˆ©æ¶¦ç‡</th>
                        <th>å‡€åˆ©æ¶¦</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <button class="btn-add" onclick="addRow()">+ æ·»åŠ ä¸€è¡Œ</button>
        <div class="footer">æ•°æ®ä»…ä¾›è§„åˆ’å‚è€ƒï¼Œå®é™…äº¤æ˜“è¯·ä»¥æ¸¸æˆå†…ä¸ºå‡†</div>
    </div>

    <script>
        // å•†å“æ•°æ®åº“
        const products = [
            {n:"é»åœŸ",w:15,p:"nian tu"}, {n:"æ£‰èŠ±",w:13,p:"mian hua"}, {n:"èŒ¶å¶",w:13,p:"cha ye"},
            {n:"é“çŸ¿çŸ³",w:34,p:"tie kuang shi"}, {n:"é“œçŸ¿çŸ³",w:35,p:"tong kuang shi"}, {n:"è°·ç‰©",w:10,p:"gu wu"},
            {n:"è‘¡è„",w:10,p:"pu tao"}, {n:"ç¡¬æœ¨",w:15,p:"ying mu"}, {n:"è¯æ",w:11,p:"yao cai"},
            {n:"é¦™æ–™",w:10,p:"xiang liao"}, {n:"æ¯›çš®",w:18,p:"mao pi"}, {n:"èœ‚èœœ",w:29,p:"feng mi"},
            {n:"ç›",w:35,p:"yan"}, {n:"ç±³é…’",w:30,p:"mi jiu"}, {n:"é™¶å™¨",w:30,p:"tao qi"},
            {n:"è‘¡è„é…’",w:30,p:"pu tao jiu"}, {n:"å…µå™¨",w:52,p:"bing qi"}, {n:"é“œå™¨",w:55,p:"tong qi"},
            {n:"å·¥å…·",w:50,p:"gong ju"}, {n:"å¸ƒå¸›",w:16,p:"bu bo"}, {n:"èœ€é”¦",w:10,p:"shu jin"},
            {n:"æ¼†å™¨",w:32,p:"qi qi"}, {n:"ç‰å™¨",w:32,p:"yu qi"}, {n:"æµ·å—çç ",w:12,p:"hai nan zhen zhu"},
            {n:"é‡‘é“¶å™¨",w:27,p:"jin yin qi"}
        ];

        // é¢œè‰²è½®ç›˜ï¼šé»‘ â†’ ç»¿ â†’ çº¢ â†’ è“ â†’ æ©™
        const editColors = ['#000000', '#2e7d32', '#d32f2f', '#1976d2', '#f57c00'];

        window.onload = () => {
            addRow("è°·ç‰©", 14.1, 17.6, 100);
            addRow("èŒ¶å¶", 58.4, 73.1, 50);
        };

        function addRow(defName="", buy="", sell="", qty="") {
            const tbody = document.querySelector('#tradingTable tbody');
            const tr = document.createElement('tr');
            
            // åˆå§‹ editCount ä¸º 0ï¼ˆé»‘è‰²ï¼‰
            tr.dataset.editCount = '0';
            
            tr.innerHTML = `
                <td>
                    <div class="custom-select-wrapper" data-def="${defName}">
                        <input type="text" class="custom-select-input" placeholder="æœå•†å“..." autocomplete="off">
                        <div class="custom-options"></div>
                    </div>
                </td>
                <td><input type="number" class="buy-price" value="${buy}" step="0.1" placeholder="0"></td>
                <td><input type="number" class="sell-price" value="${sell}" step="0.1" placeholder="0"></td>
                <td><input type="number" class="plan-qty" value="${qty}" step="1" placeholder="0"></td>
                <td><input type="text" class="cost-display" readonly value="0"></td>
                <td><div class="rate-cell">-</div></td>
                <td><div class="profit-cell">0.00</div></td>
                <td><button class="btn-del" onclick="removeRow(this)">Ã—</button></td>
            `;
            tbody.appendChild(tr);
            
            initSelect(tr.querySelector('.custom-select-wrapper'));
            
            if(defName) {
                setTimeout(()=>{
                    const inp = tr.querySelector('.custom-select-input');
                    inp.value = defName;
                    selectOpt(tr.querySelector('.custom-select-wrapper'), defName, true);
                }, 0);
            }
            
            // ç»‘å®šè¾“å…¥äº‹ä»¶
            tr.querySelectorAll('input').forEach(i => {
                i.addEventListener('input', () => {
                    incrementEditCount(tr);
                    calcRow(tr);
                });
            });
            
            calcRow(tr);
        }

        function removeRow(btn) {
            const rows = document.querySelectorAll('#tradingTable tbody tr');
            if (rows.length > 1) {
                btn.closest('tr').remove();
            } else {
                const row = btn.closest('tr');
                row.querySelectorAll('input').forEach(i => {
                    if(!i.readOnly) i.value = '';
                    if(i.classList.contains('custom-select-input')) i.value = '';
                });
                row.dataset.editCount = '0';
                calcRow(row);
            }
        }

        function incrementEditCount(row) {
            let count = parseInt(row.dataset.editCount) || 0;
            row.dataset.editCount = (count + 1).toString();
        }

        function initSelect(wrap) {
            const inp = wrap.querySelector('.custom-select-input');
            const optsDiv = wrap.querySelector('.custom-options');
            const row = wrap.closest('tr');
            
            products.forEach(prod => {
                const d = document.createElement('div');
                d.className = 'custom-option';
                d.innerHTML = `<span>${prod.n}</span><span class="weight-tag">${prod.w}</span>`;
                d.dataset.v = prod.n;
                d.dataset.p = prod.p;
                optsDiv.appendChild(d);
            });
            
            const noRes = document.createElement('div'); 
            noRes.className='no-results'; 
            noRes.textContent='æ— åŒ¹é…å•†å“'; 
            optsDiv.appendChild(noRes);

            inp.addEventListener('focus', e => { 
                e.stopPropagation(); 
                closeAll(); 
                wrap.classList.add('open'); 
                filter(inp.value, optsDiv, noRes); 
            });
            inp.addEventListener('input', e => { 
                e.stopPropagation(); 
                wrap.classList.add('open'); 
                filter(inp.value, optsDiv, noRes); 
                incrementEditCount(row);
                calcRow(row);
            });
            
            optsDiv.addEventListener('mousedown', e => {
                e.preventDefault();
                const t = e.target.classList.contains('custom-option') ? e.target : e.target.parentElement;
                if(t.classList.contains('custom-option')) {
                    selectOpt(wrap, t.dataset.v, true);
                    incrementEditCount(row);
                    calcRow(row);
                }
            });
            
            document.addEventListener('click', e => { 
                if(!wrap.contains(e.target)) wrap.classList.remove('open'); 
            });
        }

        function filter(q, container, noRes) {
            const qs = q.toLowerCase().trim();
            let has = false;
            container.querySelectorAll('.custom-option').forEach(opt => {
                const n = opt.dataset.v, p = opt.dataset.p;
                const match = n.includes(qs) || p.replace(/\s/g,'').includes(qs) || p.split(' ').map(x=>x[0]).join('').includes(qs);
                opt.style.display = match ? 'flex' : 'none';
                if(match) has = true;
            });
            noRes.style.display = has ? 'none' : 'block';
        }

        function selectOpt(wrap, val, force) {
            const inp = wrap.querySelector('.custom-select-input');
            inp.value = val; 
            wrap.classList.remove('open');
            wrap.querySelectorAll('.custom-option').forEach(o => {
                o.classList.toggle('selected', o.dataset.v === val);
            });
        }

        function closeAll() { 
            document.querySelectorAll('.custom-select-wrapper').forEach(w => w.classList.remove('open')); 
        }

        function calcRow(row) {
            const buy = parseFloat(row.querySelector('.buy-price').value) || 0;
            const sell = parseFloat(row.querySelector('.sell-price').value) || 0;
            const qty = parseInt(row.querySelector('.plan-qty').value) || 0;
            
            const cost = buy * qty;
            const profit = (sell - buy) * qty;
            const rate = cost > 0 ? (profit / cost) * 100 : 0;
            
            row.querySelector('.cost-display').value = cost.toLocaleString('zh-CN', {maximumFractionDigits: 1});
            
            const profitCell = row.querySelector('.profit-cell');
            profitCell.textContent = profit.toLocaleString('zh-CN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            const rateCell = row.querySelector('.rate-cell');
            rateCell.textContent = rate.toFixed(1) + '%';
            
            // ===== åº”ç”¨é¢œè‰²è½®ç›˜ =====
            const count = parseInt(row.dataset.editCount) || 0;
            const color = editColors[count % editColors.length];
            
            profitCell.style.color = color;
            rateCell.style.color = color;
        }
    </script>
</body>
</html>
